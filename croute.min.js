/*!
 * conkitty-route v0.1.0, https://github.com/hoho/conkitty-route
 * (c) 2014 Marat Abdullin, MIT license
 */
$C.route=function(e,n,t,r){"use strict";function a(e,n,t){H=[],t=new g(e,n),T.push(t),H.push(t),t._flat=H}function o(e){return"function"==typeof e}function i(e){return e instanceof Array}function f(e){return"string"==typeof e}function u(e){return e instanceof Node}function c(e){!!E!=!!e&&l("Running: "+!!E)}function l(e){throw new Error(e)}function s(e,n,t,r,a,o){if(r=I[e]){if(t=[].concat(e,t||[]),(o=n._id)&&(a=r[o]))for(o=0;o<a.length;o++)a[o].apply(n,t);if(a=r[""])for(o=0;o<a.length;o++)a[o].apply(n,t)}}function p(e,n,t,r,a,o){if(o=1,t)for(;":"===e.charAt(o);)o++;return a="?"===e.charAt(o--)?2:1,e=e.substring(o+a),e in n&&!t&&l("Duplicate param"),n[e]=a,e={param:e,optional:2===a,parent:o},r&&r.push(e),r?"(?:/([^/]+))"+(2===a?"?":""):e}function h(e,t,a){var o,i,f,u,c,s,h,d={},_=[],g=[];for((e||"").replace(/^((?:(?:\:\?)|[^?#])*)(?:\?([^#]*))?(?:#(.*))?$/,function(e,n,t,r){o=(n||"").split("/"),i=(t||"").split("&"),f=r}),s=o.length,u=0;s>u;u++)((c=n(o[u]))||a&&u===s-1)&&_.push(":"===c.charAt(0)?p(c,d,t,t?r:g):t?c:"/"+c.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"));for(u=0;u<i.length;u++)(c=i[u])&&(h||(h={}),~(s=c.indexOf("="))?(s=c.substring(s+1),c=n(c.substring(0,c.length-s.length-1)),s=n(s)):s=null,":"===c.charAt(0)&&l("Invalid queryparam"),c in h&&l("Duplicate queryparam"),h[c]=s&&":"===s.charAt(0)?p(s,d,t):{value:s});return f&&(f=":"===f.charAt(0)?p(f,d,t):{value:f}),{pathname:[_,g],search:h,hash:f,params:d}}function d(e,n,t,a,u,c,l,s){switch(t.param&&a&&(l=a[t.param]),!0){case"value"in t?t.value===n:n!==r&&!l:s=!0;break;case o(l):s=(n=l(n))!==r||t.optional;break;case n===r&&t.optional:s=!0;break;case l instanceof RegExp&&n!==r:s=l.test(n);break;case i(l):s=l.indexOf(n)>=0;break;case f(l):s=l===n;break;default:s=!1}return s&&n!==r&&(e!==r&&(u[e]=n),t&&t.param&&(c[t.param]=n)),s}function _(e,n){if(n=e._a)for(;e;)e._a-=n,e=e.parent}function g(n,t,a,o,f){var u,c,s,p,v,m,b,y,k,$=this,C=/.*/,j={};if($.parent=f,$.children=[],$.uri=n,$._id="r"+ ++q,$._n={},t&&(k=t.params,(u=$.id=t.id)&&(u in D&&l("Duplicate id: "+u),D[u]=$),$.title=t.title||f&&f.title,$.renderParent=t.parent||f&&f.renderParent||e.body,$.render=s=t.render,$.dataSource=t.data,$.keep=t.keep,s&&(s=s.leave)))for(i(s)||(s=[s]),u=0;u<s.length;u++)M.on("leave",s[u],$);if(n!==r&&(n=h(n),a=[].concat(a||[],n.pathname[0]),v=new RegExp(a.join("")+"(?:/(.*))?"),m=n.pathname[1],b=n.search,y=n.hash,o||(o=1),C=function(e){j={};var n,t=e.match(v);if(t){for(n=m.length;n--;)if(!d(r,t[o+n],m[n],k,r,j))return _($),!1;if($._d=!t[o+m.length])for($._a=1,n=f;n;)n._a++,n=n.parent}return $._a?j:!1},(b||y)&&(C={pathname:C},b&&(C.search=function(){var e,n={};for(e in b)if(!d(e,x[e],b[e],k,n,j))return _($),!1;return n}),y&&(C.hash=function(e){var n=d(r,e||r,y,k,r,j)?e||!0:!1;return n||_($),n})),c=t&&t.frames))for(s in c)p=new g(s,c[s],a,o+m.length,$),H.push(p),$.children.push(p);$H.on(C,{go:function(e){n||($._a=1),$._p=j,$._s=e},leave:function(){$._p=null}})}function v(e,n,t,a,o){if(o=n.param,t&&o in t)a=t[o];else{for(a=n.parent;e&&a;)e=e.parent,a--;a=(a=e&&e._p)?a[o]:r}return a}function m(e,n,a,o,f,u,c,l){var s,p,d,_,g;for(u||(o=[],f=[],u={}),n=h(n,!0,!a),d=n.pathname[0],s=d.length;s--;)_=d[s],g=_.param?v(e,_,a):_,g!==r&&o.unshift(t(g));if(d=n.search)for(s in d)if(!(s in u)){if(u[s]=!0,_=d[s],s=t(s),_.param){if(g=v(e,_,a),i(g)){for(p=0;p<g.length;p++)f.push(s+"="+t(g[p]));continue}}else g=_.value;g!==r&&f.push(s+"="+t(g))}return!c&&(d=n.hash)&&(c=d.param?v(e,d,a):d.value),a&&(s=e.parent)&&m(s,s.uri,a,o,f,u,c,!0),l?void 0:(o=("/"+o.join("/")).replace(/\/+/g,"/"),f.length&&(o+="?"+f.join("&")),c&&(o+="#"+t(c)),o)}function b(e,n,t,a){a=this,a.ok=[],a.error=[],a._r=t=new XMLHttpRequest,t?(t.open("GET",m(n,e),!0),t.onreadystatechange=function(){if(4===t.readyState){if(a._done=a._error=!0,a._r=r,200===t.status)try{a._data=JSON.parse(t.responseText),a._error=!1}catch(e){}a.done()}},t.send()):(a._done=a._error=!0,a.done())}function y(n,t,r,a){return t=t||r,u(t)||(t=o(t)?t.call(n):e.querySelector(t)),t=u(t)?t:null,t&&((a=t._$Cid)||(t._$Cid=a=++q),n._n[a]||(n._n[a]=[r=e.createComment("")],t.appendChild(r))),t}function k(e,n,t,a,c){var l,s,p,h,d,_,g,v;if(i(e))for(l=0;l<e.length;l++)k(e[l],n,t,a,0!==l);else if((e||null===e)&&(_=y(a,e&&e.parent,t))){if(s=a._n[_._$Cid],g=s[0],p=a._p,e&&(l=f(e)?e:e.template,v=[].concat(n,p,a),h=o(e)?e.apply(a,v):l&&$C.tpl[l].apply(null,v)),!e||u(h)){for(a._dom&&j(a,!0,!0),c||(c=e&&e.replace===!1);s.length>1&&!c;)l=s.pop(),(d=l.parentNode)&&d.removeChild(l);e&&(11===h.nodeType?h=h.firstChild:(d=h.parentNode)&&d.removeChild(h))}for(u(h)||(h=r);h;)s.push(h),l=h.nextSibling,h._$Croute=a,(d=g.parentNode)&&d.insertBefore(h,g),h=l}}function $(n){if(!(n._data instanceof $)){var t,a,u,c,l=n._data!==r&&!n._dataError,p=this,h=p.datas=[],d=n.dataSource,_=0,g=n.render||"",v=function(e,t,a,c,d,v){if(e!==r&&(h[e]=t,_--),!_&&!p.rejected&&(v=n._dataError,c=n.children,l||(n._data=h,v?(k(g.error,[],u,n),s("error",n)):(k(f(g)||o(g)||i(g)||g.template?g:g.success,h,u,n),s("success",n)),k(g.after,v?[!0]:[],u,n),s("after",n)),!v))for(a=0;a<c.length;a++)d=c[a],d._id in S&&new $(d)};if(!l&&(n._data=p,u=y(n,g.parent,n.renderParent),e.title=(t=o(t=n.title)?t():t)===r?w:t,k(g.before,[],u,n),s("before",n),d!==r))for(i(d)||(d=[d]),c=function(e){_++,a.then(function(n){v(e,n)},function(){n._dataError=!0,v(e)})},t=0;t<d.length;t++)a=d[t],f(a)&&(a=new b(a,n)),o(a)&&(a=a.call(n)),h.push(a),a&&o(a.then)&&c(t);v()}}function C(e,n,t){var a,i;for(a=e.children,i=a.length;i--;)C(a[i],n);e._data&&o(e._data.reject)&&(e._data.reject(),s("stop",e)),e._data!==r&&(delete e._data,delete e._dataError,s("leave",e),n?e._dom=!0:j(e,t))}function j(e,n,t){var r,a,o,i,f;e._dom=!1,r=e._n,n=n?1:0;for(a in r)for(o=r[a];o.length>n;)i=o.pop(),(f=i.parentNode)&&f.removeChild(i);if(n||(e._n={}),t)for(r=e.children,a=r.length;a--;)j(r[a],!1,!0)}var w,E,x,A,H,N,R,S={},T=[],q=0,D={},I={before:{},success:{},error:{},after:{},stop:{},leave:{},busy:{},idle:{}},O=!1,L=0,P=/[\x20\t\r\n\f]+/,U=g.prototype,M=function(e,n){return c(),f(e)&&f(n)?$H.on(e,n):e?a(e,n):N||(N=n),M};return M.add=M,M.set=function(e,n){return c(!0),A=n,$H.go(e)},M.run=function(n){c(),w=n||"",N&&a(r,N),$H.on(r,function(){var e,n,t,a,o,i,f={};for(n=0;n<T.length;n++)if(a=T[n],a._a){for(e=a,i=a._flat,t=0;t<i.length;t++)o=i[t],o._a&&(f[o._id]=o);break}for(n in S)a=S[n],(!(t=n in f)||A||!a._s||a.keep===!1||a._dataError)&&C(a,t);S=f,A=r,e&&new $(e)}),M.on("before after stop",function(e){L+="before"===e?1:-1,R&&clearTimeout(R),R=setTimeout(function(){e=O,O=!!L,R=r,e!==O&&s(L?"busy":"idle",M)},0)}),E=!0,e.body.addEventListener("click",function(e){for(var n=e.target;n&&!(n instanceof HTMLAnchorElement);)n=n.parentNode;n&&n.host===location.host&&(e.preventDefault(),M.set(n.href))},!1),$H.run()},M.on=function(e,n,t){var r,a,i="";if(f(e)&&o(n))if(e=e.split(P),1===e.length)(r=I[e])&&(t&&((i=D[t])&&(t=i),i=t._id),(a=r[i])||(a=r[i]=[]),a.push(n));else for(i=e.length;i--;)M.on(e[i],n,t);return M},M.off=function(e,n,t){var r,a="";if(f(e)&&o(n))if(e=e.split(P),1===e.length){if(t&&((a=D[t])&&(t=a),a=t._id),(r=I[e])&&(r=r[a]))for(a=r.length;a--;)r[a]===n&&r.splice(a,1)}else for(a=e.length;a--;)M.on(e[a],n,t);return M},M.get=function(e){return D[e]},U.reload=function(){var e,n=this;if(n._id in S){for(e=n.parent;e&&!(e._data instanceof $);)e=e.parent;e||(C(n,!0,!0),new $(n))}},U.params=function(e){var n=this;for(e=e||0;n&&e>0;)n=n.parent,e--;return n&&n._p||r},U.data=function(e){var n,t=this;for(e=e||0;t&&e>0;)t=t.parent,e--;return n=t&&t._data,i(n)?i(this.dataSource)?n:n[0]:r},U.makeURI=function(e){return m(this,this.uri,e||{})},U.active=function(){return this._id in S},$H.on({search:function(e,t,r,a,o,f,u){for(t=T.length;t--;)for(f=T[t],u=f._flat,r=u.length;r--;)u[r]._a=0;for(x={},e=e.split("&"),t=0;t<e.length;t++)(a=e[t])&&(~(o=a.indexOf("="))?(o=a.substring(o+1),a=n(a.substring(0,a.length-o.length-1)),o=n(o)):o=null,(f=x[a])?(i(f)||(f=[f]),f.push(o)):f=o,x[a]=f)}},{}),U=b.prototype,U.then=function(e,n){var t=this;e&&t.ok.push(e),n&&t.error.push(n),t.done()},U.reject=function(){var e=this;e._done||(e._r&&(e._r.abort(),e._r=r),e._done=e._error=!0,e.done())},U.done=function(){var e,n,t=this;if(t._done)for(t._error?e=t.error:(e=t.ok,n=t._data);e.length;)e.shift()(n)},$.prototype.reject=function(){var e,n,t=this.datas;for(this.rejected=!0,e=t.length;e--;)n=t[e],o(n.abort)&&n.abort(),o(n.reject)&&n.reject()},M}(document,decodeURIComponent,encodeURIComponent);