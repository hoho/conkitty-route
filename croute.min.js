/*!
 * conkitty-route v0.1.0, https://github.com/hoho/conkitty-route
 * (c) 2014 Marat Abdullin, MIT license
 */
$C.route=function(e,t,n,r,a){"use strict";function i(e,t,r,a){for(t=[],r=0;r<e.length;r++)a=e[r],t.push(n(a.name)+"="+n(a.value));return t.join("&")}function o(e,t,n,r){for(r=e.children,n=0;n<r.length&&!o(r[n],t);n++);return t(e)}function f(e,t,n,r,i){var o=t.state,f=n[0],c=o?o.call(e,f,r,i):a,u=n[2];n[2]=r,c===a&&(r===Y&&u===et&&(f.disabled=!1),r===et&&(f.disabled?n[2]=u:f.disabled=!0))}function c(e,t,n){var r,a=t._f;for(r=0;r<a.length;r++)f(e,t,a[r],n)}function u(e,t,n){n=new k(e,t),U.push(n)}function s(e){return"function"==typeof e}function l(e){return e instanceof Array}function h(e){return"string"==typeof e}function p(e){return e instanceof Node}function d(e){!!q!=!!e&&_("Running: "+!!q)}function _(e){throw new Error(e)}function m(e,t,n,r,a,i){if(r=P[e]){if(n=[].concat(e,n||[]),(i=t._id)&&(a=r[i]))for(i=0;i<a.length;i++)a[i].apply(t,n);if(a=r[""])for(i=0;i<a.length;i++)a[i].apply(t,n)}}function g(e,t,n,r,a,i){if(i=1,n)for(;":"===e.charAt(i);)i++;return a="?"===e.charAt(i--)?2:1,e=e.substring(i+a),e in t&&!n&&_("Duplicate param"),t[e]=a,e={param:e,optional:2===a,parent:i},r&&r.push(e),r?"(?:/([^/]+))"+(2===a?"?":""):e}function v(e,n,r){var i,o,f,c,u,s,l,h={},p=[],d=[];for((e||"").replace(/^((?:(?:\:\?)|[^?#])*)(?:\?([^#]*))?(?:#(.*))?$/,function(e,t,n,r){i=(t||"").split("/"),o=(n||"").split("&"),f=r}),s=i.length,c=0;s>c;c++)((u=t(i[c]))||r&&c===s-1)&&p.push(":"===u.charAt(0)?g(u,h,n,n?a:d):n?u:"/"+u.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"));for(c=0;c<o.length;c++)(u=o[c])&&(l||(l={}),~(s=u.indexOf("="))?(s=u.substring(s+1),u=t(u.substring(0,u.length-s.length-1)),s=t(s)):s=ut,":"===u.charAt(0)&&_("Invalid queryparam"),u in l&&_("Duplicate queryparam"),l[u]=s&&":"===s.charAt(0)?g(s,h,n):{value:s});return f&&(f=":"===f.charAt(0)?g(f,h,n):{value:f}),{pathname:[p,d],search:l,hash:f,params:h}}function b(e,t,n,r,i,o,f,c){switch(n.param&&r&&(f=r[n.param]),!0){case"value"in n?n.value===t:t!==a&&!f:c=!0;break;case s(f):c=(t=f(t))!==a||n.optional;break;case t===a&&n.optional:c=!0;break;case f instanceof RegExp&&t!==a:c=f.test(t);break;case l(f):c=f.indexOf(t)>=0;break;case h(f):c=f===t;break;default:c=!1}return c&&t!==a&&(e!==a&&(i[e]=t),n&&n.param&&(o[n.param]=t)),c}function y(e,t){if(t=e._a)for(;e;)e._a-=t,e=e[ft]}function k(e,t,n,r,i,o){var f,c,u,s,l,h,p,d,m,g=this,j=/.*/,x={};if(g[ft]=i,g.children=[],g.uri=e,g._id="r"+ ++J,g._n={},t&&(m=t.params,g.title=t.title||i&&i.title,g[ct]=t[ft]||i&&i[ct],g.render=u=w(t.render),g.final=t.final,o?(g.isForm=!0,g.action=t.action,g._method=t.method,g.check=t.check,g.state=t.state,g.type=t.type,g[st]=t[st]):((f=g.id=t.id)&&(f in B&&_("Duplicate id: "+f),B[f]=g),g.keep=t.keep,g[W]=t.data,g.form=t.form)),e!==a&&(e=v(e),n=[].concat(n||[],e.pathname[0]),l=new RegExp(n.join("")+"(?:/(.*))?"),h=e.pathname[1],p=e.search,d=e.hash,r||(r=1),j=function(e){x={};var t,n=e.match(l);if(n){for(t=h.length;t--;)if(!b(a,n[r+t],h[t],m,a,x))return y(g),!1;if(g._d=!n[r+h.length])for(g._a=1,t=i;t;)t._a++,t=t[ft]}return g._a?x:!1},(p||d)&&(j={pathname:j},p&&(j.search=function(){var e,t={};for(e in p)if(!b(e,O[e],p[e],m,t,x))return y(g),!1;return t}),d&&(j.hash=function(e){var t=b(a,e||a,d,m,a,x)?e||!0:!1;return t||y(g),t})),c=t&&t.frames))for(u in c)s=new k(u,c[u],n,r+h.length,g),g.children.push(s);$H.on(j,{go:function(t){e||(g._a=1),g._p=x,g._s=t},leave:function(){g._p=ut}})}function w(e){e=h(e)||s(e)||l(e)||e===ut||e&&e.template?{success:e}:e||{};var t,n,r,i={};for(t=ot.length;t--;)l(r=e[n=ot[t]])||r===a||(r=[r]),r&&(i[n]=r);return i}function j(e,t,n,r,i){if(i=t.param,n&&i in n)r=n[i];else{for(r=t[ft];e&&r;)e=e[ft],r--;r=(r=e&&e._p)?r[i]:a}return r}function x(e,t,r,i,o,f,c,u){var s,h,p,d,_;for(f||(i=[],o=[],f={}),t=v(t,!0,!r),p=t.pathname[0],s=p.length;s--;)d=p[s],_=d.param?j(e,d,r):d,_!==a&&i.unshift(n(_));if(p=t.search)for(s in p)if(!(s in f)){if(f[s]=!0,d=p[s],s=n(s),d.param){if(_=j(e,d,r),l(_)){for(h=0;h<_.length;h++)o.push(s+"="+n(_[h]));continue}}else _=d.value;_!==a&&o.push(s+"="+n(_))}return!c&&(p=t.hash)&&(c=p.param?j(e,p,r):p.value),r&&(s=e[ft])&&x(s,s.uri,r,i,o,f,c,!0),u?void 0:(i=("/"+i.join("/")).replace(/\/+/g,"/"),o.length&&(i+="?"+o.join("&")),c&&(i+="#"+n(c)),i)}function $(e,t,n,r,i){i=this,i.ok=[],i.error=[],i._r=r=new XMLHttpRequest,r?(r.open(t.method||"GET",x(t,e),!0),r.onreadystatechange=function(){if(4===r.readyState){if(i._done=i._error=!0,i._r=a,200===r.status)try{i._data=JSON.parse(r.responseText),i._error=!1}catch(e){}i.done()}},n&&(n=n(r)),r.send(n)):(i._done=i._error=!0,i.done())}function C(t,n,r,a,i){return n=n||r||S,n&&!p(n)&&(n=s(n)?n.call(t):e.querySelector(n)),(n=p(n)?n:ut)&&((a=n._$Cid)||(n._$Cid=a=++J),i=(t.isForm?t[ft]:t)._n,i[a]||(i[a]=[r=e.createComment("")],n.appendChild(r))),n}function E(e,t,n,r,i,o,f,c){var u,d,_,m,g,v,b,y;if(c===a&&(c=t[e]||D[e]),l(c))try{for(u=0;u<c.length&&E(e,t,n,r,i,o,0!==u,c[u])!==!1;u++);}catch(k){return E(it,t,[k,e,u,c[u]],r,i,o),!0}else if((c||c===ut)&&(v=C(i,c&&c[ft],r))){if(d=(i.isForm?i[ft]:i)._n[v._$Cid],b=d[0],_=i._p,c){if(y=[].concat(n,_,i),o&&y.push(o),s(c)){if(m=c.apply(i,y),m===!1)return m;m===ut&&(c=ut),h(m)&&(u=m)}else u=h(c)?c:c.template;h(u)&&(m=$C.tpl[u].apply(ut,y))}if((!c||p(m))&&(N(G,0),f||(f=c&&c.replace===!1),f||N(d,1),c))if(11===m.nodeType)for(u=m.firstChild;u;)d.push(u),u[V]=i,u=u.nextSibling;else(g=m.parentNode)&&g.removeChild(m),d.push(m),m[V]=i;p(m)&&(g=b.parentNode)&&g.insertBefore(m,b)}}function A(t,n,r){if(!(t._data instanceof A)){var i,o,f,u,p=t._data!==a&&!t._dataError,d=this,_=d.datas=[],g=t[W],v=0,b=t.render,y=function(e,r,i,o,u,s){if(e!==a&&(_[e]=r,v--),!v&&!d.rejected){if(s=t._dataError,o=t.children,!p){if(t._data=_,t.isForm&&c(t[ft],t,Y),s){if(E(rt,b,[],f,t,n))return;m(rt,t)}else{if(E(nt,b,_,f,t,n))return;m(nt,t)}if(E(at,b,s?[!0]:[],f,t,n))return;m(at,t)}if(!s)for(i=0;i<o.length;i++)u=o[i],u._id in M&&new A(u)}};if(!p){if(t._data=d,f=C(t,t[ct]),e.title=(i=s(i=t.title)?i():i)===a?T:i,E(tt,b,[],f,t,n))return;if(m(tt,t),g!==a)for(l(g)||(g=[g]),u=function(e){v++,o.then(function(t){y(e,t)},function(){t._dataError=!0,y(e)})},i=0;i<g.length;i++)o=g[i],h(o)&&(o=new $(o,t,r)),s(o)&&(o=o.call(t)),_.push(o),o&&s(o.then)&&u(i)}y()}}function H(e,t){var n,r;for(n=e.children,r=n.length;r--;)H(n[r]);e._data&&s(e._data.reject)&&(e._data.reject(),e.isForm&&H(e[ft],!0),m("stop",e)),e._data!==a&&(e._data=e._dataError=a,m("leave",e),F(e,t))}function F(e,t){var n,r,a;n=e._n,t=t?1:0;for(r in n)for(a=n[r];a.length>t;)G.push(a.pop());t||(e._n={})}function N(e,t,n,r){for(;e.length>t;)r=e.pop(),(n=r.parentNode)&&n.removeChild(r)}function R(e){var t,n,r,i,o,f,c,u=[],s=[];if(e instanceof HTMLFormElement)for(r=e.elements,t=0;t<r.length;t++){if(i=r[t],c=a,o=i.name)switch(i.type){case st:case"reset":case"button":case"file":break;case"checkbox":case"radio":i.checked&&(c=i.value||"");break;case"select-multiple":for(f=i.options,c=[],n=0;n<f.length;n++)f[n].selected&&c.push(f[n].value);break;default:c=i.value||""}if(s.push([i,c]),!i.disabled&&c!==a)for(l(c)||(c=[c]),n=0;n<c.length;n++)u.push({name:o,value:c[n]})}return[u,s]}var T,D,S,q,O,I,K,L,M={},U=[],J=0,B={},G=[],P={before:{},success:{},error:{},after:{},stop:{},except:{},leave:{},busy:{},idle:{}},X=!1,z=0,Q=/[\x20\t\r\n\f]+/,V="_$Croute",W="dataSource",Y="valid",Z="invalid",et="sending",tt="before",nt="success",rt="error",at="after",it="except",ot=[tt,nt,rt,at,it],ft="parent",ct="renderParent",ut=null,st="submit",lt=k.prototype,ht=function(e,t){return d(),h(e)&&h(t)?$H.on(e,t):e?u(e,t):K||(K=t),ht};return ht.add=ht,ht.set=function(e,t,n){return d(!0),I=t,$H.go(e,a,n)},ht.run=function(t){d(),t=t||{},T=t.title||"",D=w(t.render),S=t[ft]||e.body,K&&u(a,K),$H.on(a,function(){var e,t,n,r={},i=function(e,t){return e._a?(r[e._id]=e,s(t=e.final)&&(t=t.call(e)),!!t):void 0};for(t=0;t<U.length;t++)if(n=U[t],n._a){o(e=n,i);break}for(t in M)n=M[t],t in r&&!I&&n._s&&n.keep!==!1&&!n._dataError||H(n);M=r,I=a,e&&new A(e)}),ht.on("before after stop",function(e){z+=e===tt?1:-1,L&&clearTimeout(L),L=setTimeout(function(){e=X,X=!!z,L=a,e!==X&&m(z?"busy":"idle",ht)},0)});var n=addEventListener.bind(e.body);n("click",function(e){for(var t=e.target;t&&!(t instanceof HTMLAnchorElement);)t=t.parentNode;!t||t.target||t.host!==r.host||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||1!==e.which||(e.preventDefault(),ht.set(t.href))},!1),n(st,function(t){for(var n,o,f,u,l=t.target,h=l;l&&!(n=l[V]);)l=l.parentNode;n&&(o=n.form)&&(t.preventDefault(),o=new k(a,o,a,a,n,!0),f=R(h),M[o._id]=o,o._f=f[1],o.checkForm(f=f[0])&&(o[W]=s(u=h.getAttribute("action")||o.action)?u.call(h,f,n):u,o.method=h.getAttribute("method")||o._method,c(n,o,et),new A(o,h,function(e,t,r){return t=o.type,e.setRequestHeader("Content-Type","text"===t?"text/plain":"json"===t?"application/json":"application/x-www-form-urlencoded"),f=(r=o[st])?r.call(h,f,e,n):f,"json"===t?JSON.stringify(f):f?"text"===t?f+"":i(f):a}))),o||"get"!==h.method||h.target||(f=e.createElement("a"),f.href=h.action,f.host===r.host&&(t.preventDefault(),u=f.pathname+f.search,ht.set(("/"===u[0]?u:"/"+u)+(f.search?"&":"?")+i(R(h)[0]))))}),q=!0,$H.run()},ht.on=function(e,t,n){var r,a,i="";if(h(e)&&s(t))if(e=e.split(Q),1===e.length)(r=P[e])&&(n&&((i=B[n])&&(n=i),i=n._id),(a=r[i])||(a=r[i]=[]),a.push(t));else for(i=e.length;i--;)ht.on(e[i],t,n);return ht},ht.off=function(e,t,n){var r,a="";if(h(e)&&s(t))if(e=e.split(Q),1===e.length){if(n&&((a=B[n])&&(n=a),a=n._id),(r=P[e])&&(r=r[a]))for(a=r.length;a--;)r[a]===t&&r.splice(a,1)}else for(a=e.length;a--;)ht.on(e[a],t,n);return ht},ht.get=function(e){return B[e]},lt.reload=function(){var e,t=this;if(t._id in M){for(e=t[ft];e&&!(e._data instanceof A);)e=e[ft];e||(H(t,!0),new A(t))}},lt.params=function(e){var t=this;for(e=e||0;t&&e>0;)t=t[ft],e--;return t&&t._p||a},lt.data=function(e){var t,n=this;for(e=e||0;n&&e>0;)n=n[ft],e--;return t=n&&n._data,l(t)?l(this[W])?t:t[0]:a},lt.makeURI=function(e){return x(this,this.uri,e||{})},lt.active=function(){return this._id in M},lt.checkForm=function(e){var t,n,r,i,o=this,c=o._f||[],u=o[ft],s=o.check;for(t=0;t<c.length;t++)n=c[t],r=s?s.call(u,n[0],n[1],e):a,f(u,o,n,r?(i=!0,Z):Y,r);return!i},$H.on({search:function(e,n,r,a,i,f){for(f=function(e){e._a=0},n=U.length;n--;)o(U[n],f);for(O={},e=e.split("&"),n=0;n<e.length;n++)(a=e[n])&&(~(i=a.indexOf("="))?(i=a.substring(i+1),a=t(a.substring(0,a.length-i.length-1)),i=t(i)):i=ut,(f=O[a])?(l(f)||(f=[f]),f.push(i)):f=i,O[a]=f)}},{}),lt=$.prototype,lt.then=function(e,t){var n=this;e&&n.ok.push(e),t&&n.error.push(t),n.done()},lt.reject=function(){var e=this;e._done||(e._r&&(e._r.abort(),e._r=a),e._done=e._error=!0,e.done())},lt.done=function(){var e,t,n=this;if(n._done)for(n._error?e=n.error:(e=n.ok,t=n._data);e.length;)e.shift()(t)},A.prototype.reject=function(){var e,t,n=this.datas;for(this.rejected=!0,e=n.length;e--;)t=n[e],s(t.abort)&&t.abort(),s(t.reject)&&t.reject()},ht}(document,decodeURIComponent,encodeURIComponent,location);