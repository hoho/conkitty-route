/*!
 * conkitty-route v0.1.0, https://github.com/hoho/conkitty-route
 * (c) 2014 Marat Abdullin, MIT license
 */
$C.route=function(e,t,n,r){"use strict";function a(e,t,n,a,o){var i=t.state,f=n[0],c=i?i.call(e,f,a,o):r,u=n[2];n[2]=a,c===r&&(a===z&&u===Q&&(f.disabled=!1),a===Q&&(f.disabled?n[2]=u:f.disabled=!0))}function o(e,t,n){var r,o=t._f;for(r=0;r<o.length;r++)a(e,t,o[r],n)}function i(e,t,n){S=[],n=new v(e,t),L.push(n),S.push(n),n._flat=S}function f(e){return"function"==typeof e}function c(e){return e instanceof Array}function u(e){return"string"==typeof e}function s(e){return e instanceof Node}function l(e){!!N!=!!e&&p("Running: "+!!N)}function p(e){throw new Error(e)}function h(e,t,n,r,a,o){if(r=P[e]){if(n=[].concat(e,n||[]),(o=t._id)&&(a=r[o]))for(o=0;o<a.length;o++)a[o].apply(t,n);if(a=r[""])for(o=0;o<a.length;o++)a[o].apply(t,n)}}function d(e,t,n,r,a,o){if(o=1,n)for(;":"===e.charAt(o);)o++;return a="?"===e.charAt(o--)?2:1,e=e.substring(o+a),e in t&&!n&&p("Duplicate param"),t[e]=a,e={param:e,optional:2===a,parent:o},r&&r.push(e),r?"(?:/([^/]+))"+(2===a?"?":""):e}function _(e,n,a){var o,i,f,c,u,s,l,h={},_=[],g=[];for((e||"").replace(/^((?:(?:\:\?)|[^?#])*)(?:\?([^#]*))?(?:#(.*))?$/,function(e,t,n,r){o=(t||"").split("/"),i=(n||"").split("&"),f=r}),s=o.length,c=0;s>c;c++)((u=t(o[c]))||a&&c===s-1)&&_.push(":"===u.charAt(0)?d(u,h,n,n?r:g):n?u:"/"+u.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"));for(c=0;c<i.length;c++)(u=i[c])&&(l||(l={}),~(s=u.indexOf("="))?(s=u.substring(s+1),u=t(u.substring(0,u.length-s.length-1)),s=t(s)):s=V,":"===u.charAt(0)&&p("Invalid queryparam"),u in l&&p("Duplicate queryparam"),l[u]=s&&":"===s.charAt(0)?d(s,h,n):{value:s});return f&&(f=":"===f.charAt(0)?d(f,h,n):{value:f}),{pathname:[_,g],search:l,hash:f,params:h}}function g(e,t,n,a,o,i,s,l){switch(n.param&&a&&(s=a[n.param]),!0){case"value"in n?n.value===t:t!==r&&!s:l=!0;break;case f(s):l=(t=s(t))!==r||n.optional;break;case t===r&&n.optional:l=!0;break;case s instanceof RegExp&&t!==r:l=s.test(t);break;case c(s):l=s.indexOf(t)>=0;break;case u(s):l=s===t;break;default:l=!1}return l&&t!==r&&(e!==r&&(o[e]=t),n&&n.param&&(i[n.param]=t)),l}function m(e,t){if(t=e._a)for(;e;)e._a-=t,e=e.parent}function v(t,n,a,o,i,f){var u,s,l,h,d,b,y,k,w,j=this,$=/.*/,C={};if(j.parent=i,j.children=[],j.uri=t,j._id="r"+ ++O,j._n={},n&&(w=n.params,(u=j.id=n.id)&&(u in I&&p("Duplicate id: "+u),I[u]=j),j.title=n.title||i&&i.title,j.renderParent=n.parent||i&&i.renderParent||e.body,j.render=l=n.render,f?(j.isForm=!0,j.action=n.action,j._method=n.method,j.check=n.check,j.state=n.state,j.type=n.type,j[W]=n[W]):(j.keep=n.keep,j[X]=n.data),n.form&&(j.form=new v(r,n.form,r,r,j,!0)),l&&(l=l.leave)))for(c(l)||(l=[l]),u=0;u<l.length;u++)Z.on("leave",l[u],j);if(t!==r&&(t=_(t),a=[].concat(a||[],t.pathname[0]),d=new RegExp(a.join("")+"(?:/(.*))?"),b=t.pathname[1],y=t.search,k=t.hash,o||(o=1),$=function(e){C={};var t,n=e.match(d);if(n){for(t=b.length;t--;)if(!g(r,n[o+t],b[t],w,r,C))return m(j),!1;if(j._d=!n[o+b.length])for(j._a=1,t=i;t;)t._a++,t=t.parent}return j._a?C:!1},(y||k)&&($={pathname:$},y&&($.search=function(){var e,t={};for(e in y)if(!g(e,R[e],y[e],w,t,C))return m(j),!1;return t}),k&&($.hash=function(e){var t=g(r,e||r,k,w,r,C)?e||!0:!1;return t||m(j),t})),s=n&&n.frames))for(l in s)h=new v(l,s[l],a,o+b.length,j),S.push(h),j.children.push(h);$H.on($,{go:function(e){t||(j._a=1),j._p=C,j._s=e},leave:function(){j._p=V}})}function b(e,t,n,a,o){if(o=t.param,n&&o in n)a=n[o];else{for(a=t.parent;e&&a;)e=e.parent,a--;a=(a=e&&e._p)?a[o]:r}return a}function y(e,t,a,o,i,f,u,s){var l,p,h,d,g;for(f||(o=[],i=[],f={}),t=_(t,!0,!a),h=t.pathname[0],l=h.length;l--;)d=h[l],g=d.param?b(e,d,a):d,g!==r&&o.unshift(n(g));if(h=t.search)for(l in h)if(!(l in f)){if(f[l]=!0,d=h[l],l=n(l),d.param){if(g=b(e,d,a),c(g)){for(p=0;p<g.length;p++)i.push(l+"="+n(g[p]));continue}}else g=d.value;g!==r&&i.push(l+"="+n(g))}return!u&&(h=t.hash)&&(u=h.param?b(e,h,a):h.value),a&&(l=e.parent)&&y(l,l.uri,a,o,i,f,u,!0),s?void 0:(o=("/"+o.join("/")).replace(/\/+/g,"/"),i.length&&(o+="?"+i.join("&")),u&&(o+="#"+n(u)),o)}function k(e,t,n,a,o){a=this,a.ok=[],a.error=[],a._r=n=new XMLHttpRequest,n?(n.open(t.method||"GET",y(t,e),!0),n.onreadystatechange=function(){if(4===n.readyState){if(a._done=a._error=!0,a._r=r,200===n.status)try{a._data=JSON.parse(n.responseText),a._error=!1}catch(e){}a.done()}},(o=t._b)&&(o=o(n),t._b=r),n.send(o)):(a._done=a._error=!0,a.done())}function w(t,n,r,a){return n=n||r,s(n)||(n=f(n)?n.call(t):e.querySelector(n)),n=s(n)?n:V,n&&((a=n._$Cid)||(n._$Cid=a=++O),t._n[a]||(t._n[a]=[r=e.createComment("")],n.appendChild(r))),n}function j(e,t,n,r,a){var o,i,l,p,h,d,_,g;if(c(e))for(o=0;o<e.length&&j(e[o],t,n,r,0!==o)!==!1;o++);else if((e||e===V)&&(d=w(r,e&&e.parent,n))){if(i=r._n[d._$Cid],_=i[0],l=r._p,e)if(o=u(e)?e:e.template,g=[].concat(t,l,r),f(e)){if(p=e.apply(r,g),p===!1)return p;p===V&&(e=V)}else p=o&&$C.tpl[o].apply(V,g);if((!e||s(p))&&(E(M,0),a||(a=e&&e.replace===!1),a||E(i,1),e))if(11===p.nodeType)for(o=p.firstChild;o;)i.push(o),o[G]=r,o=o.nextSibling;else(h=p.parentNode)&&h.removeChild(p),i.push(p),p[G]=r;s(p)&&(h=_.parentNode)&&h.insertBefore(p,_)}}function $(t){if(!(t._data instanceof $)){var n,a,i,s,l=t._data!==r&&!t._dataError,p=this,d=p.datas=[],_=t[X],g=0,m=t.render||"",v=function(e,n,a,s,_,v){if(e!==r&&(d[e]=n,g--),!g&&!p.rejected&&(v=t._dataError,s=t.children,l||(t._data=d,t.isForm&&o(t.parent,t,z),v?(j(m.error,[],i,t),h("error",t)):(j(u(m)||f(m)||c(m)||m.template?m:m.success,d,i,t),h("success",t)),j(m.after,v?[!0]:[],i,t),h("after",t)),!v))for(a=0;a<s.length;a++)_=s[a],_._id in F&&new $(_)};if(!l&&(t._data=p,i=w(t,m.parent,t.renderParent),e.title=(n=f(n=t.title)?n():n)===r?H:n,j(m.before,[],i,t),h("before",t),_!==r))for(c(_)||(_=[_]),s=function(e){g++,a.then(function(t){v(e,t)},function(){t._dataError=!0,v(e)})},n=0;n<_.length;n++)a=_[n],u(a)&&(a=new k(a,t)),f(a)&&(a=a.call(t)),d.push(a),a&&f(a.then)&&s(n);v()}}function C(e,t){var n,a;for(n=e.children,a=n.length;a--;)C(n[a]);e._data&&f(e._data.reject)&&(e._data.reject(),h("stop",e)),e._data!==r&&(e._data=e._dataError=r,h("leave",e),x(e,t))}function x(e,t){var n,r,a;n=e._n,t=t?1:0;for(r in n)for(a=n[r];a.length>t;)M.push(a.pop());t||(e._n={})}function E(e,t,n,r){for(;e.length>t;)r=e.pop(),(n=r.parentNode)&&n.removeChild(r)}function A(e){var t,n,a,o,i,f,u,s=[],l=[];if(e instanceof HTMLFormElement)for(a=e.elements,t=0;t<a.length;t++){if(o=a[t],u=r,i=o.name)switch(o.type){case W:case"reset":case"button":case"file":break;case"checkbox":case"radio":o.checked&&(u=o.value||"");break;case"select-multiple":for(f=o.options,u=[],n=0;n<f.length;n++)f[n].selected&&u.push(f[n].value);break;default:u=o.value||""}if(l.push([o,u]),!o.disabled&&u!==r)for(c(u)||(u=[u]),n=0;n<u.length;n++)s.push({name:i,value:u[n]})}return[s,l]}var H,N,R,T,S,q,D,F={},L=[],O=0,I={},M=[],P={before:{},success:{},error:{},after:{},stop:{},leave:{},busy:{},idle:{}},U=!1,J=0,B=/[\x20\t\r\n\f]+/,G="_$Croute",X="dataSource",z="valid",K="invalid",Q="sending",V=null,W="submit",Y=v.prototype,Z=function(e,t){return l(),u(e)&&u(t)?$H.on(e,t):e?i(e,t):q||(q=t),Z};return Z.add=Z,Z.set=function(e,t){return l(!0),T=t,$H.go(e)},Z.run=function(t){l(),H=t||"",q&&i(r,q),$H.on(r,function(){var e,t,n,a,o,i,f={};for(t=0;t<L.length;t++)if(a=L[t],a._a){for(e=a,i=a._flat,n=0;n<i.length;n++)o=i[n],o._a&&(f[o._id]=o);break}for(t in F)a=F[t],t in f&&!T&&a._s&&a.keep!==!1&&!a._dataError||C(a);F=f,T=r,e&&new $(e)}),Z.on("before after stop",function(e){J+="before"===e?1:-1,D&&clearTimeout(D),D=setTimeout(function(){e=U,U=!!J,D=r,e!==U&&h(J?"busy":"idle",Z)},0)}),e.body.addEventListener("click",function(e){for(var t=e.target;t&&!(t instanceof HTMLAnchorElement);)t=t.parentNode;t&&t.host===location.host&&(e.preventDefault(),Z.set(t.href))},!1),e.body.addEventListener(W,function(e){for(var t,r,a,i,c=e.target,u=c;c;){if((t=c[G])&&(r=t.form)){e.preventDefault(),a=A(u),F[r._id]=r,r._n=t._n,r._f=a[1],r.checkForm(a=a[0])&&(C(r,!0),r[X]=f(i=u.getAttribute("action")||r.action)?i.call(u,a,t):i,r.method=u.getAttribute("method")||r._method,r._b=function(e,o,i,f,c,s){if(o=r.type,e.setRequestHeader("Content-Type","text"===o?"text/plain":"json"===o?"application/json":"application/x-www-form-urlencoded"),a=(i=r[W])?i.call(u,a,e,t):a,"json"===o)return JSON.stringify(a);if(a){if("text"===o)return a+"";for(f=[],c=0;c<a.length;c++)s=a[c],f.push(n(s.name)+"="+n(s.value));return f.join("&")}},o(t,r,Q),new $(r));break}c=c.parentNode}}),N=!0,$H.run()},Z.on=function(e,t,n){var r,a,o="";if(u(e)&&f(t))if(e=e.split(B),1===e.length)(r=P[e])&&(n&&((o=I[n])&&(n=o),o=n._id),(a=r[o])||(a=r[o]=[]),a.push(t));else for(o=e.length;o--;)Z.on(e[o],t,n);return Z},Z.off=function(e,t,n){var r,a="";if(u(e)&&f(t))if(e=e.split(B),1===e.length){if(n&&((a=I[n])&&(n=a),a=n._id),(r=P[e])&&(r=r[a]))for(a=r.length;a--;)r[a]===t&&r.splice(a,1)}else for(a=e.length;a--;)Z.on(e[a],t,n);return Z},Z.get=function(e){return I[e]},Y.reload=function(){var e,t=this;if(t._id in F){for(e=t.parent;e&&!(e._data instanceof $);)e=e.parent;e||(C(t,!0),new $(t))}},Y.params=function(e){var t=this;for(e=e||0;t&&e>0;)t=t.parent,e--;return t&&t._p||r},Y.data=function(e){var t,n=this;for(e=e||0;n&&e>0;)n=n.parent,e--;return t=n&&n._data,c(t)?c(this[X])?t:t[0]:r},Y.makeURI=function(e){return y(this,this.uri,e||{})},Y.active=function(){return this._id in F},Y.checkForm=function(e){var t,n,o,i,f=this,c=f._f||[],u=f.parent,s=f.check;for(t=0;t<c.length;t++)n=c[t],o=s?s.call(u,n[0],n[1],e):r,a(u,f,n,o?(i=!0,K):z,o);return!i},$H.on({search:function(e,n,r,a,o,i,f){for(n=L.length;n--;)for(i=L[n],f=i._flat,r=f.length;r--;)f[r]._a=0;for(R={},e=e.split("&"),n=0;n<e.length;n++)(a=e[n])&&(~(o=a.indexOf("="))?(o=a.substring(o+1),a=t(a.substring(0,a.length-o.length-1)),o=t(o)):o=V,(i=R[a])?(c(i)||(i=[i]),i.push(o)):i=o,R[a]=i)}},{}),Y=k.prototype,Y.then=function(e,t){var n=this;e&&n.ok.push(e),t&&n.error.push(t),n.done()},Y.reject=function(){var e=this;e._done||(e._r&&(e._r.abort(),e._r=r),e._done=e._error=!0,e.done())},Y.done=function(){var e,t,n=this;if(n._done)for(n._error?e=n.error:(e=n.ok,t=n._data);e.length;)e.shift()(t)},$.prototype.reject=function(){var e,t,n=this.datas;for(this.rejected=!0,e=n.length;e--;)t=n[e],f(t.abort)&&t.abort(),f(t.reject)&&t.reject()},Z}(document,decodeURIComponent,encodeURIComponent);