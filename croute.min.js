/*!
 * conkitty-route v0.2.0, https://github.com/hoho/conkitty-route
 * (c) 2014 Marat Abdullin, MIT license
 */
window.$CR=function(e,t,n,r,i){"use strict";function a(e,t,r,i){for(t=[],r=0;r<e.length;r++)i=e[r],t.push(n(i.name)+"="+n(i.value));return t.join("&")}function o(e,t,n,r){for(r=e.children,n=0;n<r.length&&!o(r[n],t);n++);return t(e)}function f(e,t,n,r,a){var o=t.state,f=n[0],c=o?o.call(e,f,r,a):i,u=n[2];n[2]=r,c===i&&(r===Z&&u===tt&&(f.disabled=!1),r===tt&&(f.disabled?n[2]=u:f.disabled=!0))}function c(e,t,n){var r,i=t._f;for(r=0;r<i.length;r++)f(e,t,i[r],n)}function u(e,t,n){n=new k(e,t),U.push(n)}function l(e){return"function"==typeof e}function s(e){return e instanceof Array}function h(e){return"string"==typeof e}function p(e){return e instanceof Node}function d(e){!!q!=!!e&&m("Running: "+!!q)}function m(e){throw new Error(e)}function g(e,t,n,r,i,a){if(r=G[e]){if(n=[].concat(e,n||[]),(a=t._id)&&(i=r[a]))for(a=0;a<i.length;a++)i[a].apply(t,n);if(i=r[""])for(a=0;a<i.length;a++)i[a].apply(t,n)}}function _(e,t,n,r,i,a){if(a=1,n)for(;":"===e.charAt(a);)a++;return i="?"===e.charAt(a--)?2:1,e=e.substring(a+i),e in t&&!n&&m("Duplicate param"),t[e]=i,e={param:e,optional:2===i,parent:a},r&&r.push(e),r?"(?:/([^/]+))"+(2===i?"?":""):e}function v(e,n,r){var a,o,f,c,u,l,s,h={},p=[],d=[];for((e||"").replace(/^((?:(?:\:\?)|[^?#])*)(?:\?([^#]*))?(?:#(.*))?$/,function(e,t,n,r){a=(t||"").split("/"),o=(n||"").split("&"),f=r}),l=a.length,c=0;l>c;c++)((u=t(a[c]))||r&&c===l-1)&&p.push(":"===u.charAt(0)?_(u,h,n,n?i:d):n?u:"/"+u.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"));for(c=0;c<o.length;c++)(u=o[c])&&(s||(s={}),~(l=u.indexOf("="))?(l=u.substring(l+1),u=t(u.substring(0,u.length-l.length-1)),l=t(l)):l=lt,":"===u.charAt(0)&&m("Invalid queryparam"),u in s&&m("Duplicate queryparam"),s[u]=l&&":"===l.charAt(0)?_(l,h,n):{value:l});return f&&(f=":"===f.charAt(0)?_(f,h,n):{value:f}),{pathname:[p,d],search:s,hash:f,params:h}}function b(e,t,n,r,a,o,f,c){switch(n.param&&r&&(f=r[n.param]),!0){case"value"in n?n.value===t:t!==i&&!f:c=!0;break;case l(f):c=(t=f(t))!==i||n.optional;break;case t===i&&n.optional:c=!0;break;case f instanceof RegExp&&t!==i:c=f.test(t);break;case s(f):c=f.indexOf(t)>=0;break;case h(f):c=f===t;break;default:c=!1}return c&&t!==i&&(e!==i&&(a[e]=t),n&&n.param&&(o[n.param]=t)),c}function y(e,t){if(t=e._a)for(;e;)e._a-=t,e=e[ct]}function k(e,t,n,r,a,o){var f,c,u,l,s,h,p,d,g,_=this,j=/.*/,x={};if(_[ct]=a,_.children=[],_.uri=e,_._id="r"+ ++J,_._n={},t&&(g=t.params,_.title=t.title||a&&a.title,_[ut]=t[ct]||a&&a[ut],_.render=u=w(t.render),_.final=t.final,o?(_.isForm=!0,_.action=t.action,_._method=t.method,_.check=t.check,_.state=t.state,_.type=t.type,_[ft]=t[ft]):((f=_.id=t.id)&&(f in z&&m("Duplicate id: "+f),z[f]=_),_.keep=t.keep,_[W]=t.data,_.form=t.form)),e!==i&&(e=v(e),n=[].concat(n||[],e.pathname[0]),s=new RegExp(n.join("")+"(?:/(.*))?"),h=e.pathname[1],p=e.search,d=e.hash,r||(r=1),j=function(e){x={};var t,n=e.match(s);if(n){for(t=h.length;t--;)if(!b(i,n[r+t],h[t],g,i,x))return y(_),!1;if(_._d=!n[r+h.length])for(_._a=1,t=a;t;)t._a++,t=t[ct]}return _._a?x:!1},(p||d)&&(j={pathname:j},p&&(j.search=function(){var e,t={};for(e in p)if(!b(e,I[e],p[e],g,t,x))return y(_),!1;return t}),d&&(j.hash=function(e){var t=b(i,e||i,d,g,i,x)?e||!0:!1;return t||y(_),t})),c=t&&t.frames))for(u in c)l=new k(u,c[u],n,r+h.length,_),_.children.push(l);$H.on(j,{go:function(t){e||(_._a=1),_._p=x,_._s=t},leave:function(){_._p=lt}})}function w(e){e=h(e)||l(e)||s(e)||e===lt||e&&e.template?{success:e}:e||{};var t,n,r,a={},o=[nt,rt,it,at,ot];for(t=o.length;t--;)s(r=e[n=o[t]])||r===i||(r=[r]),r&&(a[n]=r);return a}function j(e,t,n,r,a){if(a=t.param,n&&a in n)r=n[a];else{for(r=t[ct];e&&r;)e=e[ct],r--;r=(r=e&&e._p)?r[a]:i}return r}function x(e,t,r,a,o,f,c,u){var l,h,p,d,m;for(f||(a=[],o=[],f={}),t=v(t,!0,!r),p=t.pathname[0],l=p.length;l--;)d=p[l],m=d.param?j(e,d,r):d,m!==i&&a.unshift(n(m));if(p=t.search)for(l in p)if(!(l in f)){if(f[l]=!0,d=p[l],l=n(l),d.param){if(m=j(e,d,r),s(m)){for(h=0;h<m.length;h++)o.push(l+"="+n(m[h]));continue}}else m=d.value;m!==i&&o.push(l+"="+n(m))}return!c&&(p=t.hash)&&(c=p.param?j(e,p,r):p.value),r&&e&&(l=e[ct])&&x(l,l.uri,r,a,o,f,c,!0),u?void 0:(a=("/"+a.join("/")).replace(/\/+/g,"/"),o.length&&(a+="?"+o.join("&")),c&&(a+="#"+n(c)),a)}function C(e,t,n,r,a,o,f,c,u,s){if(a=this,!h(e)){if((f=e.override)&&(f=f.call(t,t._p))!==i)return{d:f};o=e.parse,c=e.transform,e=e.uri,l(e)&&(e=e.call(t,t._p),s=!0)}return a.ok=[],a.err=[],a.r=r=new XMLHttpRequest,r.open(t.method||"GET",r.uri=s?e:x(t=t.isForm?t[ct]:t,e),!0),r.onreadystatechange=function(){if(4===r.readyState){if(a.d=a.e=!0,200===r.status)try{u=r.responseText,u=o?o.call(t,u,r):JSON.parse(u),a.j=c?c.call(t,u,r):u,a.e=!1}catch(e){}a.done(),a.r=i}},n&&(n=n(r)),n===st?n:void r.send(n)}function $(t,n,r,i,a){return n=n||r||D,n&&!p(n)&&(n=l(n)?n.call(t):e.querySelector(n)),(n=p(n)?n:lt)&&((i=n._$Cid)||(n._$Cid=i=++J),a=(t.isForm?t[ct]:t)._n,a[i]||(a[i]=[r=e.createComment("")],n.appendChild(r))),n}function A(t,n,r,a,o,f,c,u){var d,m,_,v,b,y,k,w,j,x,C,H,E="nextSibling";if(u===i&&(u=n[t]||N[t]||[]),s(u)){if(t===ot&&!u.length)throw r[0];try{for(c={},d=0;d<u.length&&A(t,n,r,a,o,f,c,u[d])!==!1;d++);}catch(R){r=[R,t,d,u[d]],A(ot,n,r,a,o,f,c),g(ot,o,r),x=!0}}else if((u||u===lt)&&(y=$(o,u&&u[ct],a))){if(H=(o.isForm?o[ct]:o)._n,m=H[k=y._$Cid],w=m[0],_=o._p,u){if(j=[].concat(r,_,o),f&&j.push(f),l(u)){if(v=u.apply(o,j),v===!1)return v;v===lt&&(u=lt),h(v)&&(d=v)}else d=h(u)?u:u.template,l(d)&&(v=d=d.apply(o,j));if(h(d)&&(v=S.call(o,d,j),h(v)))for(d=e.createElement("div"),d.innerHTML=v,v=e.createDocumentFragment(),d=d.firstChild;d;)C=d[E],v.appendChild(d),d=C;if(v===!1)return v}if(!u||p(v)){if(F(B,0),!(k in c||u&&u.replace===!1))for(d in H)d=H[d],c._&&d!==m||F(d,1);if(c[k]=c._=!0,u&&(b=w.parentNode))for(C=w.previousSibling,b.insertBefore(v,w),d=C?C[E]:b.firstChild;d!==w;d=d[E])m.push(d),d[V]=o}}return x}function F(e,t,n,r){for(;e.length>t;)r=e.pop(),(n=r.parentNode)&&n.removeChild(r)}function H(t,n,r){if(!(t._data instanceof H)){var a,o,f,u,p=t._data!==i&&!t[Y],d=this,m=d.datas=[],_=t[W],v=0,b=t.render,y=function(e,r,a,o,u,l){if(e!==i&&(m[e]=r,v--),!v&&!d.rejected){if(l=t[Y],o=t.children,!p){if(t._data=m,t.isForm&&c(t[ct],t,Z),a=l?it:rt,A(a,b,l||m,f,t,n))return;if(g(a,t,l||m),A(at,b,l?[!0]:[],f,t,n))return;g(at,t)}if(!l)for(a=0;a<o.length;a++)u=o[a],u._id in M&&new H(u)}};if(!p){if(t._data=d,f=$(t,t[ut]),e.title=(a=l(a=t.title)?a():a)===i?T:a,A(nt,b,[],f,t,n))return;if(g(nt,t),_!==i)for(s(_)||(_=[_]),u=function(e){v++,o.then(function(t){y(e,t)},function(n,r){(r=t[Y])||(r=t[Y]=new Array(m.length)),r[e]=n,y(e)})},a=0;a<_.length;a++)(o=_[a])&&((h(o)||l(o.uri)||h(o.uri))&&(o=new C(o,t,r),o.then||(o=o.d)),l(o)&&(o=o.call(t)),m.push(o),o&&l(o.then)&&u(a))}y()}}function E(e,t,n){var r,a,o,f;for(r=e.children,a=r.length;a--;)E(r[a],t);if(e._data&&l(e._data.reject)&&(e._data.reject(),e.isForm&&!e._c&&E(e[ct],t,!0),g("stop",e)),e._data!==i&&(e._data=e[Y]=i,g("leave",e),!(e._id in t))){o=e._n,n=n?1:0;for(a in o)for(f=o[a];f.length>n;)B.push(f.pop());n||(e._n={})}}function R(e,t){var n,r,a,o,f,c,u,l=[],h=[];if(e instanceof HTMLFormElement)for(a=e.elements,n=0;n<a.length;n++){if(o=a[n],u=i,f=o.name)switch(o.type){case ft:case"reset":case"button":case"file":break;case"checkbox":case"radio":o.checked&&(u=o.value||"");break;case"select-multiple":for(c=o.options,u=[],r=0;r<c.length;r++)c[r].selected&&u.push(c[r].value);break;default:u=o.value||""}if(h.push([o,u]),!o.disabled&&u!==i)for(s(u)||(u=[u]),r=0;r<u.length;r++)l.push({name:f,value:u[r]})}return t?[l,h]:l}var T,N,D,S,q,I,L,O,K,M={},U=[],J=0,z={},B=[],G={before:{},success:{},error:{},after:{},stop:{},except:{},leave:{},busy:{},idle:{}},P=!1,X=0,Q=/[\x20\t\r\n\f]+/,V="_$Croute",W="dataSource",Y="_dataError",Z="valid",et="invalid",tt="sending",nt="before",rt="success",it="error",at="after",ot="except",ft="submit",ct="parent",ut="renderParent",lt=null,st={d:lt},ht=k.prototype,pt=function(e,t){return d(),h(e)&&h(t)?$H.on(e,t):e?u(e,t):O||(O=t),pt};return pt.add=pt,pt.set=function(e,t,n){return d(!0),L=t,$H.go(e,i,n)},pt.run=function(t){d();var n=e.body,f=n.addEventListener.bind(n);t=t||{},T=t.title||"",N=w(t.render),D=t[ct]||n,S=t.callTemplate||function(e,t,n){return(n=$C.tpl[e])||m("No `"+e+"` template"),n.apply(lt,t)},O&&u(i,O),$H.on(i,function(){var e,t,n,r,a={},f=0,c=0,u=function(e,t,n){return e._a?(a[t=e._id]=e,f++,r||t in M||(r=!0),l(n=e.final)&&(n=n.call(e)),!!n):void 0};for(t=0;t<U.length;t++)if(n=U[t],n._a){o(e=n,u);break}for(t in M)c++,n=M[t],t=t in a,(!t||L||!n._s||n.keep===!1||n[Y])&&E(n,a),t&&(n._s=1);!r&&c>f&&F(B,0),M=a,L=i,e&&new H(e)}),pt.on("before after stop",function(e){X+=e===nt?1:-1,K&&clearTimeout(K),K=setTimeout(function(){e=P,P=!!X,K=i,e!==P&&g(X?"busy":"idle",pt)},0)}),f("click",function(e){for(var t=e.target;t&&!(t instanceof HTMLAnchorElement);)t=t.parentNode;!t||t.target||t.host!==r.host||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||1!==e.which||(e.preventDefault(),pt.set(t.href))},!1),f(ft,function(t){for(var n,o,f,u,s=t.target,h=s;s&&!(n=s[V]);)s=s.parentNode;n&&(o=n.form)&&(t.preventDefault(),o=new k(i,o,i,i,n,!0),f=R(h,!0),M[o._id]=o,o._f=f[1],o.checkForm(f=f[0])&&(o[W]=l(u=h.getAttribute("action")||o.action)?u.call(h,f,n):u||r.href,o.method=h.getAttribute("method")||o._method||"get",new H(o,h,function(e,t,r,u){return t=o.type,e.setRequestHeader("Content-Type","text"===t?"text/plain":"json"===t?"application/json":"application/x-www-form-urlencoded"),h.cancel=function(){o._c=u=st},f=(r=o[ft])?r.call(h,f,e,n):f,delete h.cancel,u||c(n,o,tt),u||("json"===t?JSON.stringify(f):f?"text"===t?f+"":a(f):i)}))),o||"get"!==h.method||h.target||(f=e.createElement("a"),f.href=h.action,f.host===r.host&&(t.preventDefault(),u=f.pathname+f.search,pt.set(("/"===u[0]?u:"/"+u)+(f.search?"&":"?")+a(R(h)))))}),q=!0,$H.run()},pt.serializeForm=R,pt.makeURI=function(e,t){return x(i,e,t)},pt.on=function(e,t,n){var r,i,a="";if(h(e)&&l(t))if(e=e.split(Q),1===e.length)(r=G[e])&&(n&&((a=z[n])&&(n=a),a=n._id),(i=r[a])||(i=r[a]=[]),i.push(t));else for(a=e.length;a--;)pt.on(e[a],t,n);return pt},pt.off=function(e,t,n){var r,i="";if(h(e)&&l(t))if(e=e.split(Q),1===e.length){if(n&&((i=z[n])&&(n=i),i=n._id),(r=G[e])&&(r=r[i]))for(i=r.length;i--;)r[i]===t&&r.splice(i,1)}else for(i=e.length;i--;)pt.on(e[i],t,n);return pt},pt.get=function(e){return z[e]},pt.params=function(){return I},ht.reload=function(){var e,t=this;if(t._id in M){for(e=t[ct];e&&!(e._data instanceof H);)e=e[ct];e||(E(t,M,!0),new H(t))}},ht.params=function(e){var t=this;for(e=e||0;t&&e>0;)t=t[ct],e--;return t&&t._p||i},ht.data=function(e){var t,n=this;for(e=e||0;n&&e>0;)n=n[ct],e--;return t=n&&n._data,s(t)?s(this[W])?t:t[0]:i},ht.makeURI=function(e){return x(this,this.uri,e||{})},ht.active=function(e){return this._id in M&&(e?1===this._s:!0)},ht.checkForm=function(e){var t,n,r,a,o=this,c=o._f||[],u=o[ct],l=o.check;for(t=0;t<c.length;t++)n=c[t],r=l?l.call(u,n[0],n[1],e):i,f(u,o,n,r?(a=!0,et):Z,r);return!a},$H.on({search:function(e,n,r,i,a,f){for(f=function(e){e._a=0},n=U.length;n--;)o(U[n],f);for(I={},e=e.split("&"),n=0;n<e.length;n++)(i=e[n])&&(~(a=i.indexOf("="))?(a=i.substring(a+1),i=t(i.substring(0,i.length-a.length-1)),a=t(a)):a=lt,(f=I[i])?(s(f)||(f=[f]),f.push(a)):f=a,I[i]=f)}},{}),ht=C.prototype,ht.then=function(e,t){var n=this;e&&n.ok.push(e),t&&n.err.push(t),n.done()},ht.reject=function(){var e=this;e.d||(e.r&&(e.r.abort(),e.r=i),e.d=e.e=!0,e.done())},ht.done=function(){var e,t,n=this;if(n.d)for(n.e?(e=n.err,t=n.r):(e=n.ok,t=n.j);e.length;)e.shift()(t)},H.prototype.reject=function(){var e,t,n=this.datas;for(this.rejected=!0,e=n.length;e--;)t=n[e],l(t.abort)&&t.abort(),l(t.reject)&&t.reject()},pt}(document,decodeURIComponent,encodeURIComponent,location);