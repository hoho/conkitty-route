/*!
 * conkitty-route v0.1.0, https://github.com/hoho/conkitty-route
 * (c) 2014 Marat Abdullin, MIT license
 */
$C.route=function(e,n,t,r){"use strict";function a(e,n,r,a,o){if("json"===n)return JSON.stringify(e);if(e){if("text"===n)return e+"";for(a=[],r=0;r<e.length;r++)o=e[r],a.push(t(o.name)+"="+t(o.value));return a.join("&")}}function o(e,n,t,a,o){var i=n.state,f=t[0],c=i?i.call(e,f,a,o):r,u=t[2];t[2]=a,c===r&&(a===K&&u===V&&(f.disabled=!1),a===V&&(f.disabled?t[2]=u:f.disabled=!0))}function i(e,n,t){var r,a=n._f;for(r=0;r<a.length;r++)o(e,n,a[r],t)}function f(e,n,t){q=[],t=new b(e,n),O.push(t),q.push(t),t._flat=q}function c(e){return"function"==typeof e}function u(e){return e instanceof Array}function s(e){return"string"==typeof e}function l(e){return e instanceof Node}function p(e){!!R!=!!e&&h("Running: "+!!R)}function h(e){throw new Error(e)}function d(e,n,t,r,a,o){if(r=U[e]){if(t=[].concat(e,t||[]),(o=n._id)&&(a=r[o]))for(o=0;o<a.length;o++)a[o].apply(n,t);if(a=r[""])for(o=0;o<a.length;o++)a[o].apply(n,t)}}function _(e,n,t,r,a,o){if(o=1,t)for(;":"===e.charAt(o);)o++;return a="?"===e.charAt(o--)?2:1,e=e.substring(o+a),e in n&&!t&&h("Duplicate param"),n[e]=a,e={param:e,optional:2===a,parent:o},r&&r.push(e),r?"(?:/([^/]+))"+(2===a?"?":""):e}function g(e,t,a){var o,i,f,c,u,s,l,p={},d=[],g=[];for((e||"").replace(/^((?:(?:\:\?)|[^?#])*)(?:\?([^#]*))?(?:#(.*))?$/,function(e,n,t,r){o=(n||"").split("/"),i=(t||"").split("&"),f=r}),s=o.length,c=0;s>c;c++)((u=n(o[c]))||a&&c===s-1)&&d.push(":"===u.charAt(0)?_(u,p,t,t?r:g):t?u:"/"+u.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"));for(c=0;c<i.length;c++)(u=i[c])&&(l||(l={}),~(s=u.indexOf("="))?(s=u.substring(s+1),u=n(u.substring(0,u.length-s.length-1)),s=n(s)):s=null,":"===u.charAt(0)&&h("Invalid queryparam"),u in l&&h("Duplicate queryparam"),l[u]=s&&":"===s.charAt(0)?_(s,p,t):{value:s});return f&&(f=":"===f.charAt(0)?_(f,p,t):{value:f}),{pathname:[d,g],search:l,hash:f,params:p}}function m(e,n,t,a,o,i,f,l){switch(t.param&&a&&(f=a[t.param]),!0){case"value"in t?t.value===n:n!==r&&!f:l=!0;break;case c(f):l=(n=f(n))!==r||t.optional;break;case n===r&&t.optional:l=!0;break;case f instanceof RegExp&&n!==r:l=f.test(n);break;case u(f):l=f.indexOf(n)>=0;break;case s(f):l=f===n;break;default:l=!1}return l&&n!==r&&(e!==r&&(o[e]=n),t&&t.param&&(i[t.param]=n)),l}function v(e,n){if(n=e._a)for(;e;)e._a-=n,e=e.parent}function b(n,t,a,o,i,f){var c,s,l,p,d,_,y,k,w,j=this,$=/.*/,C={};if(j.parent=i,j.children=[],j.uri=n,j._id="r"+ ++I,j._n={},t&&(w=t.params,(c=j.id=t.id)&&(c in M&&h("Duplicate id: "+c),M[c]=j),j.title=t.title||i&&i.title,j.renderParent=t.parent||i&&i.renderParent||e.body,j.render=l=t.render,f?(j.isForm=!0,j.action=t.action,j._method=t.method,j.check=t.check,j.state=t.state,j.type=t.type,j[W]=t[W]):(j.keep=t.keep,j[z]=t.data),t.form&&(j.form=new b(r,t.form,r,r,j,!0)),l&&(l=l.leave)))for(u(l)||(l=[l]),c=0;c<l.length;c++)Z.on("leave",l[c],j);if(n!==r&&(n=g(n),a=[].concat(a||[],n.pathname[0]),d=new RegExp(a.join("")+"(?:/(.*))?"),_=n.pathname[1],y=n.search,k=n.hash,o||(o=1),$=function(e){C={};var n,t=e.match(d);if(t){for(n=_.length;n--;)if(!m(r,t[o+n],_[n],w,r,C))return v(j),!1;if(j._d=!t[o+_.length])for(j._a=1,n=i;n;)n._a++,n=n.parent}return j._a?C:!1},(y||k)&&($={pathname:$},y&&($.search=function(){var e,n={};for(e in y)if(!m(e,T[e],y[e],w,n,C))return v(j),!1;return n}),k&&($.hash=function(e){var n=m(r,e||r,k,w,r,C)?e||!0:!1;return n||v(j),n})),s=t&&t.frames))for(l in s)p=new b(l,s[l],a,o+_.length,j),q.push(p),j.children.push(p);$H.on($,{go:function(e){n||(j._a=1),j._p=C,j._s=e},leave:function(){j._p=null}})}function y(e,n,t,a,o){if(o=n.param,t&&o in t)a=t[o];else{for(a=n.parent;e&&a;)e=e.parent,a--;a=(a=e&&e._p)?a[o]:r}return a}function k(e,n,a,o,i,f,c,s){var l,p,h,d,_;for(f||(o=[],i=[],f={}),n=g(n,!0,!a),h=n.pathname[0],l=h.length;l--;)d=h[l],_=d.param?y(e,d,a):d,_!==r&&o.unshift(t(_));if(h=n.search)for(l in h)if(!(l in f)){if(f[l]=!0,d=h[l],l=t(l),d.param){if(_=y(e,d,a),u(_)){for(p=0;p<_.length;p++)i.push(l+"="+t(_[p]));continue}}else _=d.value;_!==r&&i.push(l+"="+t(_))}return!c&&(h=n.hash)&&(c=h.param?y(e,h,a):h.value),a&&(l=e.parent)&&k(l,l.uri,a,o,i,f,c,!0),s?void 0:(o=("/"+o.join("/")).replace(/\/+/g,"/"),i.length&&(o+="?"+i.join("&")),c&&(o+="#"+t(c)),o)}function w(e,n,t,a,o){a=this,a.ok=[],a.error=[],a._r=t=new XMLHttpRequest,t?(t.open(n.method||"GET",k(n,e),!0),t.onreadystatechange=function(){if(4===t.readyState){if(a._done=a._error=!0,a._r=r,200===t.status)try{a._data=JSON.parse(t.responseText),a._error=!1}catch(e){}a.done()}},(o=n._b)&&(o=o(t),n._b=r),t.send(o)):(a._done=a._error=!0,a.done())}function j(n,t,r,a){return t=t||r,l(t)||(t=c(t)?t.call(n):e.querySelector(t)),t=l(t)?t:null,t&&((a=t._$Cid)||(t._$Cid=a=++I),n._n[a]||(n._n[a]=[r=e.createComment("")],t.appendChild(r))),t}function $(e,n,t,r,a){var o,i,f,p,h,d,_,g;if(u(e))for(o=0;o<e.length;o++)$(e[o],n,t,r,0!==o);else if((e||null===e)&&(d=j(r,e&&e.parent,t))){if(i=r._n[d._$Cid],_=i[0],f=r._p,e&&(o=s(e)?e:e.template,g=[].concat(n,f,r),p=c(e)?e.apply(r,g):o&&$C.tpl[o].apply(null,g)),(!e||l(p))&&(H(P,0),a||(a=e&&e.replace===!1),a||H(i,1),e))if(11===p.nodeType)for(o=p.firstChild;o;)i.push(o),o[X]=r,o=o.nextSibling;else(h=p.parentNode)&&h.removeChild(p),i.push(p),p[X]=r;l(p)&&(h=_.parentNode)&&h.insertBefore(p,_)}}function C(n){if(!(n._data instanceof C)){var t,a,o,f,l=n._data!==r&&!n._dataError,p=this,h=p.datas=[],_=n[z],g=0,m=n.render||"",v=function(e,t,a,f,_,v){if(e!==r&&(h[e]=t,g--),!g&&!p.rejected&&(v=n._dataError,f=n.children,l||(n._data=h,n.isForm&&i(n.parent,n,K),v?($(m.error,[],o,n),d("error",n)):($(s(m)||c(m)||u(m)||m.template?m:m.success,h,o,n),d("success",n)),$(m.after,v?[!0]:[],o,n),d("after",n)),!v))for(a=0;a<f.length;a++)_=f[a],_._id in L&&new C(_)};if(!l&&(n._data=p,o=j(n,m.parent,n.renderParent),e.title=(t=c(t=n.title)?t():t)===r?N:t,$(m.before,[],o,n),d("before",n),_!==r))for(u(_)||(_=[_]),f=function(e){g++,a.then(function(n){v(e,n)},function(){n._dataError=!0,v(e)})},t=0;t<_.length;t++)a=_[t],s(a)&&(a=new w(a,n)),c(a)&&(a=a.call(n)),h.push(a),a&&c(a.then)&&f(t);v()}}function x(e,n){var t,a;for(t=e.children,a=t.length;a--;)x(t[a]);e._data&&c(e._data.reject)&&(e._data.reject(),d("stop",e)),e._data!==r&&(e._data=e._dataError=r,d("leave",e),E(e,n))}function E(e,n){var t,r,a;t=e._n,n=n?1:0;for(r in t)for(a=t[r];a.length>n;)P.push(a.pop());n||(e._n={})}function H(e,n,t,r){for(;e.length>n;)r=e.pop(),(t=r.parentNode)&&t.removeChild(r)}function A(e){var n,t,a,o,i,f,c,s=[],l=[];if(e instanceof HTMLFormElement)for(a=e.elements,n=0;n<a.length;n++){if(o=a[n],c=r,i=o.name)switch(o.type){case W:case"reset":case"button":case"file":break;case"checkbox":case"radio":o.checked&&(c=o.value||"");break;case"select-multiple":for(f=o.options,c=[],t=0;t<f.length;t++)f[t].selected&&c.push(f[t].value);break;default:c=o.value||""}if(l.push([o,c]),!o.disabled&&c!==r)for(u(c)||(c=[c]),t=0;t<c.length;t++)s.push({name:i,value:c[t]})}return[s,l]}var N,R,T,S,q,D,F,L={},O=[],I=0,M={},P=[],U={before:{},success:{},error:{},after:{},stop:{},leave:{},busy:{},idle:{}},J=!1,B=0,G=/[\x20\t\r\n\f]+/,X="_$Croute",z="dataSource",K="valid",Q="invalid",V="sending",W="submit",Y=b.prototype,Z=function(e,n){return p(),s(e)&&s(n)?$H.on(e,n):e?f(e,n):D||(D=n),Z};return Z.add=Z,Z.set=function(e,n){return p(!0),S=n,$H.go(e)},Z.run=function(n){p(),N=n||"",D&&f(r,D),$H.on(r,function(){var e,n,t,a,o,i,f={};for(n=0;n<O.length;n++)if(a=O[n],a._a){for(e=a,i=a._flat,t=0;t<i.length;t++)o=i[t],o._a&&(f[o._id]=o);break}for(n in L)a=L[n],n in f&&!S&&a._s&&a.keep!==!1&&!a._dataError||x(a);L=f,S=r,e&&new C(e)}),Z.on("before after stop",function(e){B+="before"===e?1:-1,F&&clearTimeout(F),F=setTimeout(function(){e=J,J=!!B,F=r,e!==J&&d(B?"busy":"idle",Z)},0)}),e.body.addEventListener("click",function(e){for(var n=e.target;n&&!(n instanceof HTMLAnchorElement);)n=n.parentNode;n&&n.host===location.host&&(e.preventDefault(),Z.set(n.href))},!1),e.body.addEventListener(W,function(e){for(var n,t,r,o=e.target,f=o;o;){if((n=o[X])&&(t=n.form)){e.preventDefault(),r=A(f),L[t._id]=t,t._n=n._n,t._f=r[1],t.checkForm(r=r[0])&&(x(t,!0),t[z]=t.action||f.action,t.method=t._method||f.method,t._b=function(e,o,i){return o=t.type,e.setRequestHeader("Content-Type","text"===o?"text/plain":"json"===o?"application/json":"application/x-www-form-urlencoded"),a((i=t[W])?i.call(n,r,e):r,o)},i(n,t,V),new C(t));break}o=o.parentNode}}),R=!0,$H.run()},Z.on=function(e,n,t){var r,a,o="";if(s(e)&&c(n))if(e=e.split(G),1===e.length)(r=U[e])&&(t&&((o=M[t])&&(t=o),o=t._id),(a=r[o])||(a=r[o]=[]),a.push(n));else for(o=e.length;o--;)Z.on(e[o],n,t);return Z},Z.off=function(e,n,t){var r,a="";if(s(e)&&c(n))if(e=e.split(G),1===e.length){if(t&&((a=M[t])&&(t=a),a=t._id),(r=U[e])&&(r=r[a]))for(a=r.length;a--;)r[a]===n&&r.splice(a,1)}else for(a=e.length;a--;)Z.on(e[a],n,t);return Z},Z.get=function(e){return M[e]},Y.reload=function(){var e,n=this;if(n._id in L){for(e=n.parent;e&&!(e._data instanceof C);)e=e.parent;e||(x(n,!0),new C(n))}},Y.params=function(e){var n=this;for(e=e||0;n&&e>0;)n=n.parent,e--;return n&&n._p||r},Y.data=function(e){var n,t=this;for(e=e||0;t&&e>0;)t=t.parent,e--;return n=t&&t._data,u(n)?u(this[z])?n:n[0]:r},Y.makeURI=function(e){return k(this,this.uri,e||{})},Y.active=function(){return this._id in L},Y.checkForm=function(e){var n,t,a,i,f=this,c=f._f||[],u=f.parent,s=f.check;for(n=0;n<c.length;n++)t=c[n],a=s?s.call(u,t[0],t[1],e):r,o(u,f,t,a?(i=!0,Q):K,a);return!i},$H.on({search:function(e,t,r,a,o,i,f){for(t=O.length;t--;)for(i=O[t],f=i._flat,r=f.length;r--;)f[r]._a=0;for(T={},e=e.split("&"),t=0;t<e.length;t++)(a=e[t])&&(~(o=a.indexOf("="))?(o=a.substring(o+1),a=n(a.substring(0,a.length-o.length-1)),o=n(o)):o=null,(i=T[a])?(u(i)||(i=[i]),i.push(o)):i=o,T[a]=i)}},{}),Y=w.prototype,Y.then=function(e,n){var t=this;e&&t.ok.push(e),n&&t.error.push(n),t.done()},Y.reject=function(){var e=this;e._done||(e._r&&(e._r.abort(),e._r=r),e._done=e._error=!0,e.done())},Y.done=function(){var e,n,t=this;if(t._done)for(t._error?e=t.error:(e=t.ok,n=t._data);e.length;)e.shift()(n)},C.prototype.reject=function(){var e,n,t=this.datas;for(this.rejected=!0,e=t.length;e--;)n=t[e],c(n.abort)&&n.abort(),c(n.reject)&&n.reject()},Z}(document,decodeURIComponent,encodeURIComponent);