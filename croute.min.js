/*!
 * conkitty-route v0.1.0, https://github.com/hoho/conkitty-route
 * (c) 2014 Marat Abdullin, MIT license
 */
$C.route=function(e,t,n,r){"use strict";function a(e,t,n,r){for(r=e.children,n=0;n<r.length&&!a(r[n],t);n++);return t(e)}function o(e,t,n,a,o){var i=t.state,f=n[0],c=i?i.call(e,f,a,o):r,u=n[2];n[2]=a,c===r&&(a===V&&u===Y&&(f.disabled=!1),a===Y&&(f.disabled?n[2]=u:f.disabled=!0))}function i(e,t,n){var r,a=t._f;for(r=0;r<a.length;r++)o(e,t,a[r],n)}function f(e,t,n){n=new b(e,t),M.push(n)}function c(e){return"function"==typeof e}function u(e){return e instanceof Array}function s(e){return"string"==typeof e}function l(e){return e instanceof Node}function p(e){!!q!=!!e&&h("Running: "+!!q)}function h(e){throw new Error(e)}function d(e,t,n,r,a,o){if(r=G[e]){if(n=[].concat(e,n||[]),(o=t._id)&&(a=r[o]))for(o=0;o<a.length;o++)a[o].apply(t,n);if(a=r[""])for(o=0;o<a.length;o++)a[o].apply(t,n)}}function _(e,t,n,r,a,o){if(o=1,n)for(;":"===e.charAt(o);)o++;return a="?"===e.charAt(o--)?2:1,e=e.substring(o+a),e in t&&!n&&h("Duplicate param"),t[e]=a,e={param:e,optional:2===a,parent:o},r&&r.push(e),r?"(?:/([^/]+))"+(2===a?"?":""):e}function g(e,n,a){var o,i,f,c,u,s,l,p={},d=[],g=[];for((e||"").replace(/^((?:(?:\:\?)|[^?#])*)(?:\?([^#]*))?(?:#(.*))?$/,function(e,t,n,r){o=(t||"").split("/"),i=(n||"").split("&"),f=r}),s=o.length,c=0;s>c;c++)((u=t(o[c]))||a&&c===s-1)&&d.push(":"===u.charAt(0)?_(u,p,n,n?r:g):n?u:"/"+u.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"));for(c=0;c<i.length;c++)(u=i[c])&&(l||(l={}),~(s=u.indexOf("="))?(s=u.substring(s+1),u=t(u.substring(0,u.length-s.length-1)),s=t(s)):s=it,":"===u.charAt(0)&&h("Invalid queryparam"),u in l&&h("Duplicate queryparam"),l[u]=s&&":"===s.charAt(0)?_(s,p,n):{value:s});return f&&(f=":"===f.charAt(0)?_(f,p,n):{value:f}),{pathname:[d,g],search:l,hash:f,params:p}}function m(e,t,n,a,o,i,f,l){switch(n.param&&a&&(f=a[n.param]),!0){case"value"in n?n.value===t:t!==r&&!f:l=!0;break;case c(f):l=(t=f(t))!==r||n.optional;break;case t===r&&n.optional:l=!0;break;case f instanceof RegExp&&t!==r:l=f.test(t);break;case u(f):l=f.indexOf(t)>=0;break;case s(f):l=f===t;break;default:l=!1}return l&&t!==r&&(e!==r&&(o[e]=t),n&&n.param&&(i[n.param]=t)),l}function v(e,t){if(t=e._a)for(;e;)e._a-=t,e=e.parent}function b(e,t,n,a,o,i){var f,c,u,s,l,p,d,_,k,w=this,j=/.*/,x={};if(w.parent=o,w.children=[],w.uri=e,w._id="r"+ ++U,w._n={},t&&(k=t.params,(f=w.id=t.id)&&(f in J&&h("Duplicate id: "+f),J[f]=w),w.title=t.title||o&&o.title,w[ot]=t.parent||o&&o[ot],w.render=u=y(t.render),w.final=t.final,i?(w.isForm=!0,w.action=t.action,w._method=t.method,w.check=t.check,w.state=t.state,w.type=t.type,w[ft]=t[ft]):(w.keep=t.keep,w[Q]=t.data),t.form&&(w.form=new b(r,t.form,r,r,w,!0))),e!==r&&(e=g(e),n=[].concat(n||[],e.pathname[0]),l=new RegExp(n.join("")+"(?:/(.*))?"),p=e.pathname[1],d=e.search,_=e.hash,a||(a=1),j=function(e){x={};var t,n=e.match(l);if(n){for(t=p.length;t--;)if(!m(r,n[a+t],p[t],k,r,x))return v(w),!1;if(w._d=!n[a+p.length])for(w._a=1,t=o;t;)t._a++,t=t.parent}return w._a?x:!1},(d||_)&&(j={pathname:j},d&&(j.search=function(){var e,t={};for(e in d)if(!m(e,D[e],d[e],k,t,x))return v(w),!1;return t}),_&&(j.hash=function(e){var t=m(r,e||r,_,k,r,x)?e||!0:!1;return t||v(w),t})),c=t&&t.frames))for(u in c)s=new b(u,c[u],n,a+p.length,w),w.children.push(s);$H.on(j,{go:function(t){e||(w._a=1),w._p=x,w._s=t},leave:function(){w._p=it}})}function y(e){e=s(e)||c(e)||u(e)||e===it||e&&e.template?{success:e}:e||{};var t,n,a,o={};for(t=at.length;t--;)u(a=e[n=at[t]])||a===r||(a=[a]),a&&(o[n]=a);return o}function k(e,t,n,a,o){if(o=t.param,n&&o in n)a=n[o];else{for(a=t.parent;e&&a;)e=e.parent,a--;a=(a=e&&e._p)?a[o]:r}return a}function w(e,t,a,o,i,f,c,s){var l,p,h,d,_;for(f||(o=[],i=[],f={}),t=g(t,!0,!a),h=t.pathname[0],l=h.length;l--;)d=h[l],_=d.param?k(e,d,a):d,_!==r&&o.unshift(n(_));if(h=t.search)for(l in h)if(!(l in f)){if(f[l]=!0,d=h[l],l=n(l),d.param){if(_=k(e,d,a),u(_)){for(p=0;p<_.length;p++)i.push(l+"="+n(_[p]));continue}}else _=d.value;_!==r&&i.push(l+"="+n(_))}return!c&&(h=t.hash)&&(c=h.param?k(e,h,a):h.value),a&&(l=e.parent)&&w(l,l.uri,a,o,i,f,c,!0),s?void 0:(o=("/"+o.join("/")).replace(/\/+/g,"/"),i.length&&(o+="?"+i.join("&")),c&&(o+="#"+n(c)),o)}function j(e,t,n,a,o){o=this,o.ok=[],o.error=[],o._r=a=new XMLHttpRequest,a?(a.open(t.method||"GET",w(t,e),!0),a.onreadystatechange=function(){if(4===a.readyState){if(o._done=o._error=!0,o._r=r,200===a.status)try{o._data=JSON.parse(a.responseText),o._error=!1}catch(e){}o.done()}},n&&(n=n(a)),a.send(n)):(o._done=o._error=!0,o.done())}function x(t,n,r,a){return n=n||r||S,n&&!l(n)&&(n=c(n)?n.call(t):e.querySelector(n)),(n=l(n)?n:it)&&((a=n._$Cid)||(n._$Cid=a=++U),t._n[a]||(t._n[a]=[r=e.createComment("")],n.appendChild(r))),n}function $(e,t,n,a,o,i,f,p){var h,d,_,g,m,v,b,y;if(p===r&&(p=t[e]||T[e]),u(p))try{for(h=0;h<p.length&&$(e,t,n,a,o,i,0!==h,p[h])!==!1;h++);}catch(k){$(rt,t,[k,e,h,p[h]],a,o,i)}else if((p||p===it)&&(v=x(o,p&&p.parent,a))){if(d=o._n[v._$Cid],b=d[0],_=o._p,p){if(y=[].concat(n,_,o),i&&y.push(i),c(p)){if(g=p.apply(o,y),g===!1)return g;g===it&&(p=it),s(g)&&(h=g)}else h=s(p)?p:p.template;s(h)&&(g=$C.tpl[h].apply(it,y))}if((!p||l(g))&&(H(B,0),f||(f=p&&p.replace===!1),f||H(d,1),p))if(11===g.nodeType)for(h=g.firstChild;h;)d.push(h),h[K]=o,h=h.nextSibling;else(m=g.parentNode)&&m.removeChild(g),d.push(g),g[K]=o;l(g)&&(m=b.parentNode)&&m.insertBefore(g,b)}}function C(t,n,a){if(!(t._data instanceof C)){var o,f,l,p,h=t._data!==r&&!t._dataError,_=this,g=_.datas=[],m=t[Q],v=0,b=t.render,y=function(e,a,o,f,c,u){if(e!==r&&(g[e]=a,v--),!v&&!_.rejected&&(u=t._dataError,f=t.children,h||(t._data=g,t.isForm&&i(t.parent,t,V),u?($(tt,b,[],l,t,n),d(tt,t)):($(et,b,g,l,t,n),d(et,t)),$(nt,b,u?[!0]:[],l,t,n),d(nt,t)),!u))for(o=0;o<f.length;o++)c=f[o],c._id in I&&new C(c)};if(!h&&(t._data=_,l=x(t,t[ot]),e.title=(o=c(o=t.title)?o():o)===r?R:o,$(Z,b,[],l,t,n),d(Z,t),m!==r))for(u(m)||(m=[m]),p=function(e){v++,f.then(function(t){y(e,t)},function(){t._dataError=!0,y(e)})},o=0;o<m.length;o++)f=m[o],s(f)&&(f=new j(f,t,a)),c(f)&&(f=f.call(t)),g.push(f),f&&c(f.then)&&p(o);y()}}function E(e,t){var n,a;for(n=e.children,a=n.length;a--;)E(n[a]);e._data&&c(e._data.reject)&&(e._data.reject(),d("stop",e)),e._data!==r&&(e._data=e._dataError=r,d("leave",e),A(e,t))}function A(e,t){var n,r,a;n=e._n,t=t?1:0;for(r in n)for(a=n[r];a.length>t;)B.push(a.pop());t||(e._n={})}function H(e,t,n,r){for(;e.length>t;)r=e.pop(),(n=r.parentNode)&&n.removeChild(r)}function N(e){var t,n,a,o,i,f,c,s=[],l=[];if(e instanceof HTMLFormElement)for(a=e.elements,t=0;t<a.length;t++){if(o=a[t],c=r,i=o.name)switch(o.type){case ft:case"reset":case"button":case"file":break;case"checkbox":case"radio":o.checked&&(c=o.value||"");break;case"select-multiple":for(f=o.options,c=[],n=0;n<f.length;n++)f[n].selected&&c.push(f[n].value);break;default:c=o.value||""}if(l.push([o,c]),!o.disabled&&c!==r)for(u(c)||(c=[c]),n=0;n<c.length;n++)s.push({name:i,value:c[n]})}return[s,l]}var R,T,S,q,D,F,L,O,I={},M=[],U=0,J={},B=[],G={before:{},success:{},error:{},after:{},stop:{},except:{},leave:{},busy:{},idle:{}},P=!1,X=0,z=/[\x20\t\r\n\f]+/,K="_$Croute",Q="dataSource",V="valid",W="invalid",Y="sending",Z="before",et="success",tt="error",nt="after",rt="except",at=[Z,et,tt,nt,rt],ot="renderParent",it=null,ft="submit",ct=b.prototype,ut=function(e,t){return p(),s(e)&&s(t)?$H.on(e,t):e?f(e,t):L||(L=t),ut};return ut.add=ut,ut.set=function(e,t){return p(!0),F=t,$H.go(e)},ut.run=function(t){p(),t=t||{},R=t.title||"",T=y(t.render),S=t.parent||e.body,L&&f(r,L),$H.on(r,function(){var e,t,n,o={};for(t=0;t<M.length;t++)if(n=M[t],n._a){a(e=n,function(e,t){return e._a?(o[e._id]=e,c(t=e.final)&&(t=t.call(e)),!!t):void 0});break}for(t in I)n=I[t],t in o&&!F&&n._s&&n.keep!==!1&&!n._dataError||E(n);I=o,F=r,e&&new C(e)}),ut.on("before after stop",function(e){X+=e===Z?1:-1,O&&clearTimeout(O),O=setTimeout(function(){e=P,P=!!X,O=r,e!==P&&d(X?"busy":"idle",ut)},0)}),e.body.addEventListener("click",function(e){for(var t=e.target;t&&!(t instanceof HTMLAnchorElement);)t=t.parentNode;t&&t.host===location.host&&(e.preventDefault(),ut.set(t.href))},!1),e.body.addEventListener(ft,function(e){for(var t,r,a,o,f=e.target,u=f;f;){if((t=f[K])&&(r=t.form)){e.preventDefault(),a=N(u),I[r._id]=r,r._n=t._n,r._f=a[1],r.checkForm(a=a[0])&&(E(r,!0),r[Q]=c(o=u.getAttribute("action")||r.action)?o.call(u,a,t):o,r.method=u.getAttribute("method")||r._method,i(t,r,Y),new C(r,u,function(e,o,i,f,c,s){if(o=r.type,e.setRequestHeader("Content-Type","text"===o?"text/plain":"json"===o?"application/json":"application/x-www-form-urlencoded"),a=(i=r[ft])?i.call(u,a,e,t):a,"json"===o)return JSON.stringify(a);if(a){if("text"===o)return a+"";for(f=[],c=0;c<a.length;c++)s=a[c],f.push(n(s.name)+"="+n(s.value));return f.join("&")}}));break}f=f.parentNode}}),q=!0,$H.run()},ut.on=function(e,t,n){var r,a,o="";if(s(e)&&c(t))if(e=e.split(z),1===e.length)(r=G[e])&&(n&&((o=J[n])&&(n=o),o=n._id),(a=r[o])||(a=r[o]=[]),a.push(t));else for(o=e.length;o--;)ut.on(e[o],t,n);return ut},ut.off=function(e,t,n){var r,a="";if(s(e)&&c(t))if(e=e.split(z),1===e.length){if(n&&((a=J[n])&&(n=a),a=n._id),(r=G[e])&&(r=r[a]))for(a=r.length;a--;)r[a]===t&&r.splice(a,1)}else for(a=e.length;a--;)ut.on(e[a],t,n);return ut},ut.get=function(e){return J[e]},ct.reload=function(){var e,t=this;if(t._id in I){for(e=t.parent;e&&!(e._data instanceof C);)e=e.parent;e||(E(t,!0),new C(t))}},ct.params=function(e){var t=this;for(e=e||0;t&&e>0;)t=t.parent,e--;return t&&t._p||r},ct.data=function(e){var t,n=this;for(e=e||0;n&&e>0;)n=n.parent,e--;return t=n&&n._data,u(t)?u(this[Q])?t:t[0]:r},ct.makeURI=function(e){return w(this,this.uri,e||{})},ct.active=function(){return this._id in I},ct.checkForm=function(e){var t,n,a,i,f=this,c=f._f||[],u=f.parent,s=f.check;for(t=0;t<c.length;t++)n=c[t],a=s?s.call(u,n[0],n[1],e):r,o(u,f,n,a?(i=!0,W):V,a);return!i},$H.on({search:function(e,n,r,o,i,f){for(n=M.length;n--;)a(M[n],function(e){e._a=0});for(D={},e=e.split("&"),n=0;n<e.length;n++)(o=e[n])&&(~(i=o.indexOf("="))?(i=o.substring(i+1),o=t(o.substring(0,o.length-i.length-1)),i=t(i)):i=it,(f=D[o])?(u(f)||(f=[f]),f.push(i)):f=i,D[o]=f)}},{}),ct=j.prototype,ct.then=function(e,t){var n=this;e&&n.ok.push(e),t&&n.error.push(t),n.done()},ct.reject=function(){var e=this;e._done||(e._r&&(e._r.abort(),e._r=r),e._done=e._error=!0,e.done())},ct.done=function(){var e,t,n=this;if(n._done)for(n._error?e=n.error:(e=n.ok,t=n._data);e.length;)e.shift()(t)},C.prototype.reject=function(){var e,t,n=this.datas;for(this.rejected=!0,e=n.length;e--;)t=n[e],c(t.abort)&&t.abort(),c(t.reject)&&t.reject()},ut}(document,decodeURIComponent,encodeURIComponent);