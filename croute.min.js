/*!
 * conkitty-route v0.1.0, https://github.com/hoho/conkitty-route
 * (c) 2014 Marat Abdullin, MIT license
 */
$C.route=function(e,t,n,r){"use strict";function a(e,t,n,r){for(r=e.children,n=0;n<r.length&&!a(r[n],t);n++);return t(e)}function i(e,t,n,a,i){var o=t.state,f=n[0],c=o?o.call(e,f,a,i):r,u=n[2];n[2]=a,c===r&&(a===V&&u===Y&&(f.disabled=!1),a===Y&&(f.disabled?n[2]=u:f.disabled=!0))}function o(e,t,n){var r,a=t._f;for(r=0;r<a.length;r++)i(e,t,a[r],n)}function f(e,t,n){n=new b(e,t),L.push(n)}function c(e){return"function"==typeof e}function u(e){return e instanceof Array}function s(e){return"string"==typeof e}function l(e){return e instanceof Node}function h(e){!!S!=!!e&&p("Running: "+!!S)}function p(e){throw new Error(e)}function d(e,t,n,r,a,i){if(r=B[e]){if(n=[].concat(e,n||[]),(i=t._id)&&(a=r[i]))for(i=0;i<a.length;i++)a[i].apply(t,n);if(a=r[""])for(i=0;i<a.length;i++)a[i].apply(t,n)}}function _(e,t,n,r,a,i){if(i=1,n)for(;":"===e.charAt(i);)i++;return a="?"===e.charAt(i--)?2:1,e=e.substring(i+a),e in t&&!n&&p("Duplicate param"),t[e]=a,e={param:e,optional:2===a,parent:i},r&&r.push(e),r?"(?:/([^/]+))"+(2===a?"?":""):e}function g(e,n,a){var i,o,f,c,u,s,l,h={},d=[],g=[];for((e||"").replace(/^((?:(?:\:\?)|[^?#])*)(?:\?([^#]*))?(?:#(.*))?$/,function(e,t,n,r){i=(t||"").split("/"),o=(n||"").split("&"),f=r}),s=i.length,c=0;s>c;c++)((u=t(i[c]))||a&&c===s-1)&&d.push(":"===u.charAt(0)?_(u,h,n,n?r:g):n?u:"/"+u.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"));for(c=0;c<o.length;c++)(u=o[c])&&(l||(l={}),~(s=u.indexOf("="))?(s=u.substring(s+1),u=t(u.substring(0,u.length-s.length-1)),s=t(s)):s=ft,":"===u.charAt(0)&&p("Invalid queryparam"),u in l&&p("Duplicate queryparam"),l[u]=s&&":"===s.charAt(0)?_(s,h,n):{value:s});return f&&(f=":"===f.charAt(0)?_(f,h,n):{value:f}),{pathname:[d,g],search:l,hash:f,params:h}}function m(e,t,n,a,i,o,f,l){switch(n.param&&a&&(f=a[n.param]),!0){case"value"in n?n.value===t:t!==r&&!f:l=!0;break;case c(f):l=(t=f(t))!==r||n.optional;break;case t===r&&n.optional:l=!0;break;case f instanceof RegExp&&t!==r:l=f.test(t);break;case u(f):l=f.indexOf(t)>=0;break;case s(f):l=f===t;break;default:l=!1}return l&&t!==r&&(e!==r&&(i[e]=t),n&&n.param&&(o[n.param]=t)),l}function v(e,t){if(t=e._a)for(;e;)e._a-=t,e=e[it]}function b(e,t,n,a,i,o){var f,c,u,s,l,h,d,_,k,w=this,j=/.*/,x={};if(w[it]=i,w.children=[],w.uri=e,w._id="r"+ ++M,w._n={},t&&(k=t.params,w.title=t.title||i&&i.title,w[ot]=t[it]||i&&i[ot],w.render=u=y(t.render),w.final=t.final,o?(w.isForm=!0,w.action=t.action,w._method=t.method,w.check=t.check,w.state=t.state,w.type=t.type,w[ct]=t[ct]):((f=w.id=t.id)&&(f in U&&p("Duplicate id: "+f),U[f]=w),w.keep=t.keep,w[Q]=t.data,w.form=t.form)),e!==r&&(e=g(e),n=[].concat(n||[],e.pathname[0]),l=new RegExp(n.join("")+"(?:/(.*))?"),h=e.pathname[1],d=e.search,_=e.hash,a||(a=1),j=function(e){x={};var t,n=e.match(l);if(n){for(t=h.length;t--;)if(!m(r,n[a+t],h[t],k,r,x))return v(w),!1;if(w._d=!n[a+h.length])for(w._a=1,t=i;t;)t._a++,t=t[it]}return w._a?x:!1},(d||_)&&(j={pathname:j},d&&(j.search=function(){var e,t={};for(e in d)if(!m(e,q[e],d[e],k,t,x))return v(w),!1;return t}),_&&(j.hash=function(e){var t=m(r,e||r,_,k,r,x)?e||!0:!1;return t||v(w),t})),c=t&&t.frames))for(u in c)s=new b(u,c[u],n,a+h.length,w),w.children.push(s);$H.on(j,{go:function(t){e||(w._a=1),w._p=x,w._s=t},leave:function(){w._p=ft}})}function y(e){e=s(e)||c(e)||u(e)||e===ft||e&&e.template?{success:e}:e||{};var t,n,a,i={};for(t=at.length;t--;)u(a=e[n=at[t]])||a===r||(a=[a]),a&&(i[n]=a);return i}function k(e,t,n,a,i){if(i=t.param,n&&i in n)a=n[i];else{for(a=t[it];e&&a;)e=e[it],a--;a=(a=e&&e._p)?a[i]:r}return a}function w(e,t,a,i,o,f,c,s){var l,h,p,d,_;for(f||(i=[],o=[],f={}),t=g(t,!0,!a),p=t.pathname[0],l=p.length;l--;)d=p[l],_=d.param?k(e,d,a):d,_!==r&&i.unshift(n(_));if(p=t.search)for(l in p)if(!(l in f)){if(f[l]=!0,d=p[l],l=n(l),d.param){if(_=k(e,d,a),u(_)){for(h=0;h<_.length;h++)o.push(l+"="+n(_[h]));continue}}else _=d.value;_!==r&&o.push(l+"="+n(_))}return!c&&(p=t.hash)&&(c=p.param?k(e,p,a):p.value),a&&(l=e[it])&&w(l,l.uri,a,i,o,f,c,!0),s?void 0:(i=("/"+i.join("/")).replace(/\/+/g,"/"),o.length&&(i+="?"+o.join("&")),c&&(i+="#"+n(c)),i)}function j(e,t,n,a,i){i=this,i.ok=[],i.error=[],i._r=a=new XMLHttpRequest,a?(a.open(t.method||"GET",w(t,e),!0),a.onreadystatechange=function(){if(4===a.readyState){if(i._done=i._error=!0,i._r=r,200===a.status)try{i._data=JSON.parse(a.responseText),i._error=!1}catch(e){}i.done()}},n&&(n=n(a)),a.send(n)):(i._done=i._error=!0,i.done())}function x(t,n,r,a,i){return n=n||r||T,n&&!l(n)&&(n=c(n)?n.call(t):e.querySelector(n)),(n=l(n)?n:ft)&&((a=n._$Cid)||(n._$Cid=a=++M),i=(t.isForm?t[it]:t)._n,i[a]||(i[a]=[r=e.createComment("")],n.appendChild(r))),n}function $(e,t,n,a,i,o,f,h){var p,d,_,g,m,v,b,y;if(h===r&&(h=t[e]||R[e]),u(h))try{for(p=0;p<h.length&&$(e,t,n,a,i,o,0!==p,h[p])!==!1;p++);}catch(k){return $(rt,t,[k,e,p,h[p]],a,i,o),!0}else if((h||h===ft)&&(v=x(i,h&&h[it],a))){if(d=(i.isForm?i[it]:i)._n[v._$Cid],b=d[0],_=i._p,h){if(y=[].concat(n,_,i),o&&y.push(o),c(h)){if(g=h.apply(i,y),g===!1)return g;g===ft&&(h=ft),s(g)&&(p=g)}else p=s(h)?h:h.template;s(p)&&(g=$C.tpl[p].apply(ft,y))}if((!h||l(g))&&(H(J,0),f||(f=h&&h.replace===!1),f||H(d,1),h))if(11===g.nodeType)for(p=g.firstChild;p;)d.push(p),p[z]=i,p=p.nextSibling;else(m=g.parentNode)&&m.removeChild(g),d.push(g),g[z]=i;l(g)&&(m=b.parentNode)&&m.insertBefore(g,b)}}function C(t,n,a){if(!(t._data instanceof C)){var i,f,l,h,p=t._data!==r&&!t._dataError,_=this,g=_.datas=[],m=t[Q],v=0,b=t.render,y=function(e,a,i,f,c,u){if(e!==r&&(g[e]=a,v--),!v&&!_.rejected){if(u=t._dataError,f=t.children,!p){if(t._data=g,t.isForm&&o(t[it],t,V),u){if($(tt,b,[],l,t,n))return;d(tt,t)}else{if($(et,b,g,l,t,n))return;d(et,t)}if($(nt,b,u?[!0]:[],l,t,n))return;d(nt,t)}if(!u)for(i=0;i<f.length;i++)c=f[i],c._id in K&&new C(c)}};if(!p){if(t._data=_,l=x(t,t[ot]),e.title=(i=c(i=t.title)?i():i)===r?N:i,$(Z,b,[],l,t,n))return;if(d(Z,t),m!==r)for(u(m)||(m=[m]),h=function(e){v++,f.then(function(t){y(e,t)},function(){t._dataError=!0,y(e)})},i=0;i<m.length;i++)f=m[i],s(f)&&(f=new j(f,t,a)),c(f)&&(f=f.call(t)),g.push(f),f&&c(f.then)&&h(i)}y()}}function E(e,t){var n,a;for(n=e.children,a=n.length;a--;)E(n[a]);e._data&&c(e._data.reject)&&(e._data.reject(),e.isForm&&E(e[it],!0),d("stop",e)),e._data!==r&&(e._data=e._dataError=r,d("leave",e),A(e,t))}function A(e,t){var n,r,a;n=e._n,t=t?1:0;for(r in n)for(a=n[r];a.length>t;)J.push(a.pop());t||(e._n={})}function H(e,t,n,r){for(;e.length>t;)r=e.pop(),(n=r.parentNode)&&n.removeChild(r)}function F(e){var t,n,a,i,o,f,c,s=[],l=[];if(e instanceof HTMLFormElement)for(a=e.elements,t=0;t<a.length;t++){if(i=a[t],c=r,o=i.name)switch(i.type){case ct:case"reset":case"button":case"file":break;case"checkbox":case"radio":i.checked&&(c=i.value||"");break;case"select-multiple":for(f=i.options,c=[],n=0;n<f.length;n++)f[n].selected&&c.push(f[n].value);break;default:c=i.value||""}if(l.push([i,c]),!i.disabled&&c!==r)for(u(c)||(c=[c]),n=0;n<c.length;n++)s.push({name:o,value:c[n]})}return[s,l]}var N,R,T,S,q,D,O,I,K={},L=[],M=0,U={},J=[],B={before:{},success:{},error:{},after:{},stop:{},except:{},leave:{},busy:{},idle:{}},G=!1,P=0,X=/[\x20\t\r\n\f]+/,z="_$Croute",Q="dataSource",V="valid",W="invalid",Y="sending",Z="before",et="success",tt="error",nt="after",rt="except",at=[Z,et,tt,nt,rt],it="parent",ot="renderParent",ft=null,ct="submit",ut=b.prototype,st=function(e,t){return h(),s(e)&&s(t)?$H.on(e,t):e?f(e,t):O||(O=t),st};return st.add=st,st.set=function(e,t){return h(!0),D=t,$H.go(e)},st.run=function(t){h(),t=t||{},N=t.title||"",R=y(t.render),T=t[it]||e.body,O&&f(r,O),$H.on(r,function(){var e,t,n,i={};for(t=0;t<L.length;t++)if(n=L[t],n._a){a(e=n,function(e,t){return e._a?(i[e._id]=e,c(t=e.final)&&(t=t.call(e)),!!t):void 0});break}for(t in K)n=K[t],t in i&&!D&&n._s&&n.keep!==!1&&!n._dataError||E(n);K=i,D=r,e&&new C(e)}),st.on("before after stop",function(e){P+=e===Z?1:-1,I&&clearTimeout(I),I=setTimeout(function(){e=G,G=!!P,I=r,e!==G&&d(P?"busy":"idle",st)},0)});var i=addEventListener.bind(e.body);i("click",function(e){for(var t=e.target;t&&!(t instanceof HTMLAnchorElement);)t=t.parentNode;!t||t.target||t.host!==location.host||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||1!==e.which||(e.preventDefault(),st.set(t.href))},!1),i(ct,function(e){for(var t,a,i,f,u=e.target,s=u;u;){if((t=u[z])&&(a=t.form)){e.preventDefault(),a=new b(r,a,r,r,t,!0),i=F(s),K[a._id]=a,a._f=i[1],a.checkForm(i=i[0])&&(E(a,!0),a[Q]=c(f=s.getAttribute("action")||a.action)?f.call(s,i,t):f,a.method=s.getAttribute("method")||a._method,o(t,a,Y),new C(a,s,function(e,r,o,f,c,u){if(r=a.type,e.setRequestHeader("Content-Type","text"===r?"text/plain":"json"===r?"application/json":"application/x-www-form-urlencoded"),i=(o=a[ct])?o.call(s,i,e,t):i,"json"===r)return JSON.stringify(i);if(i){if("text"===r)return i+"";for(f=[],c=0;c<i.length;c++)u=i[c],f.push(n(u.name)+"="+n(u.value));return f.join("&")}}));break}u=u.parentNode}}),S=!0,$H.run()},st.on=function(e,t,n){var r,a,i="";if(s(e)&&c(t))if(e=e.split(X),1===e.length)(r=B[e])&&(n&&((i=U[n])&&(n=i),i=n._id),(a=r[i])||(a=r[i]=[]),a.push(t));else for(i=e.length;i--;)st.on(e[i],t,n);return st},st.off=function(e,t,n){var r,a="";if(s(e)&&c(t))if(e=e.split(X),1===e.length){if(n&&((a=U[n])&&(n=a),a=n._id),(r=B[e])&&(r=r[a]))for(a=r.length;a--;)r[a]===t&&r.splice(a,1)}else for(a=e.length;a--;)st.on(e[a],t,n);return st},st.get=function(e){return U[e]},ut.reload=function(){var e,t=this;if(t._id in K){for(e=t[it];e&&!(e._data instanceof C);)e=e[it];e||(E(t,!0),new C(t))}},ut.params=function(e){var t=this;for(e=e||0;t&&e>0;)t=t[it],e--;return t&&t._p||r},ut.data=function(e){var t,n=this;for(e=e||0;n&&e>0;)n=n[it],e--;return t=n&&n._data,u(t)?u(this[Q])?t:t[0]:r},ut.makeURI=function(e){return w(this,this.uri,e||{})},ut.active=function(){return this._id in K},ut.checkForm=function(e){var t,n,a,o,f=this,c=f._f||[],u=f[it],s=f.check;for(t=0;t<c.length;t++)n=c[t],a=s?s.call(u,n[0],n[1],e):r,i(u,f,n,a?(o=!0,W):V,a);return!o},$H.on({search:function(e,n,r,i,o,f){for(n=L.length;n--;)a(L[n],function(e){e._a=0});for(q={},e=e.split("&"),n=0;n<e.length;n++)(i=e[n])&&(~(o=i.indexOf("="))?(o=i.substring(o+1),i=t(i.substring(0,i.length-o.length-1)),o=t(o)):o=ft,(f=q[i])?(u(f)||(f=[f]),f.push(o)):f=o,q[i]=f)}},{}),ut=j.prototype,ut.then=function(e,t){var n=this;e&&n.ok.push(e),t&&n.error.push(t),n.done()},ut.reject=function(){var e=this;e._done||(e._r&&(e._r.abort(),e._r=r),e._done=e._error=!0,e.done())},ut.done=function(){var e,t,n=this;if(n._done)for(n._error?e=n.error:(e=n.ok,t=n._data);e.length;)e.shift()(t)},C.prototype.reject=function(){var e,t,n=this.datas;for(this.rejected=!0,e=n.length;e--;)t=n[e],c(t.abort)&&t.abort(),c(t.reject)&&t.reject()},st}(document,decodeURIComponent,encodeURIComponent);