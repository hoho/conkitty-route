/*!
 * conkitty-route v0.1.0, https://github.com/hoho/conkitty-route
 * (c) 2014 Marat Abdullin, MIT license
 */
$C.route=function(e,t,n,r){"use strict";function a(e,t,n,a,o){var i=t.state,f=n[0],c=i?i.call(e,f,a,o):r,u=n[2];n[2]=a,c===r&&(a===V&&u===Y&&(f.disabled=!1),a===Y&&(f.disabled?n[2]=u:f.disabled=!0))}function o(e,t,n){var r,o=t._f;for(r=0;r<o.length;r++)a(e,t,o[r],n)}function i(e,t,n){F=[],n=new v(e,t),M.push(n),F.push(n),n._flat=F}function f(e){return"function"==typeof e}function c(e){return e instanceof Array}function u(e){return"string"==typeof e}function s(e){return e instanceof Node}function l(e){!!S!=!!e&&p("Running: "+!!S)}function p(e){throw new Error(e)}function h(e,t,n,r,a,o){if(r=B[e]){if(n=[].concat(e,n||[]),(o=t._id)&&(a=r[o]))for(o=0;o<a.length;o++)a[o].apply(t,n);if(a=r[""])for(o=0;o<a.length;o++)a[o].apply(t,n)}}function d(e,t,n,r,a,o){if(o=1,n)for(;":"===e.charAt(o);)o++;return a="?"===e.charAt(o--)?2:1,e=e.substring(o+a),e in t&&!n&&p("Duplicate param"),t[e]=a,e={param:e,optional:2===a,parent:o},r&&r.push(e),r?"(?:/([^/]+))"+(2===a?"?":""):e}function _(e,n,a){var o,i,f,c,u,s,l,h={},_=[],g=[];for((e||"").replace(/^((?:(?:\:\?)|[^?#])*)(?:\?([^#]*))?(?:#(.*))?$/,function(e,t,n,r){o=(t||"").split("/"),i=(n||"").split("&"),f=r}),s=o.length,c=0;s>c;c++)((u=t(o[c]))||a&&c===s-1)&&_.push(":"===u.charAt(0)?d(u,h,n,n?r:g):n?u:"/"+u.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"));for(c=0;c<i.length;c++)(u=i[c])&&(l||(l={}),~(s=u.indexOf("="))?(s=u.substring(s+1),u=t(u.substring(0,u.length-s.length-1)),s=t(s)):s=ot,":"===u.charAt(0)&&p("Invalid queryparam"),u in l&&p("Duplicate queryparam"),l[u]=s&&":"===s.charAt(0)?d(s,h,n):{value:s});return f&&(f=":"===f.charAt(0)?d(f,h,n):{value:f}),{pathname:[_,g],search:l,hash:f,params:h}}function g(e,t,n,a,o,i,s,l){switch(n.param&&a&&(s=a[n.param]),!0){case"value"in n?n.value===t:t!==r&&!s:l=!0;break;case f(s):l=(t=s(t))!==r||n.optional;break;case t===r&&n.optional:l=!0;break;case s instanceof RegExp&&t!==r:l=s.test(t);break;case c(s):l=s.indexOf(t)>=0;break;case u(s):l=s===t;break;default:l=!1}return l&&t!==r&&(e!==r&&(o[e]=t),n&&n.param&&(i[n.param]=t)),l}function m(e,t){if(t=e._a)for(;e;)e._a-=t,e=e.parent}function v(e,t,n,a,o,i){var f,c,u,s,l,h,d,y,k,w=this,j=/.*/,x={};if(w.parent=o,w.children=[],w.uri=e,w._id="r"+ ++P,w._n={},t&&(k=t.params,(f=w.id=t.id)&&(f in U&&p("Duplicate id: "+f),U[f]=w),w.title=t.title||o&&o.title,w.renderParent=t.parent||o&&o.renderParent,w.render=u=b(t.render),i?(w.isForm=!0,w.action=t.action,w._method=t.method,w.check=t.check,w.state=t.state,w.type=t.type,w[it]=t[it]):(w.keep=t.keep,w[Q]=t.data),t.form&&(w.form=new v(r,t.form,r,r,w,!0))),e!==r&&(e=_(e),n=[].concat(n||[],e.pathname[0]),l=new RegExp(n.join("")+"(?:/(.*))?"),h=e.pathname[1],d=e.search,y=e.hash,a||(a=1),j=function(e){x={};var t,n=e.match(l);if(n){for(t=h.length;t--;)if(!g(r,n[a+t],h[t],k,r,x))return m(w),!1;if(w._d=!n[a+h.length])for(w._a=1,t=o;t;)t._a++,t=t.parent}return w._a?x:!1},(d||y)&&(j={pathname:j},d&&(j.search=function(){var e,t={};for(e in d)if(!g(e,q[e],d[e],k,t,x))return m(w),!1;return t}),y&&(j.hash=function(e){var t=g(r,e||r,y,k,r,x)?e||!0:!1;return t||m(w),t})),c=t&&t.frames))for(u in c)s=new v(u,c[u],n,a+h.length,w),F.push(s),w.children.push(s);$H.on(j,{go:function(t){e||(w._a=1),w._p=x,w._s=t},leave:function(){w._p=ot}})}function b(e){e=u(e)||f(e)||c(e)||e===ot||e&&e.template?{success:e}:e||{};var t,n,a,o={};for(t=at.length;t--;)c(a=e[n=at[t]])||a===r||(a=[a]),a&&(o[n]=a);return o}function y(e,t,n,a,o){if(o=t.param,n&&o in n)a=n[o];else{for(a=t.parent;e&&a;)e=e.parent,a--;a=(a=e&&e._p)?a[o]:r}return a}function k(e,t,a,o,i,f,u,s){var l,p,h,d,g;for(f||(o=[],i=[],f={}),t=_(t,!0,!a),h=t.pathname[0],l=h.length;l--;)d=h[l],g=d.param?y(e,d,a):d,g!==r&&o.unshift(n(g));if(h=t.search)for(l in h)if(!(l in f)){if(f[l]=!0,d=h[l],l=n(l),d.param){if(g=y(e,d,a),c(g)){for(p=0;p<g.length;p++)i.push(l+"="+n(g[p]));continue}}else g=d.value;g!==r&&i.push(l+"="+n(g))}return!u&&(h=t.hash)&&(u=h.param?y(e,h,a):h.value),a&&(l=e.parent)&&k(l,l.uri,a,o,i,f,u,!0),s?void 0:(o=("/"+o.join("/")).replace(/\/+/g,"/"),i.length&&(o+="?"+i.join("&")),u&&(o+="#"+n(u)),o)}function w(e,t,n,a,o){o=this,o.ok=[],o.error=[],o._r=a=new XMLHttpRequest,a?(a.open(t.method||"GET",k(t,e),!0),a.onreadystatechange=function(){if(4===a.readyState){if(o._done=o._error=!0,o._r=r,200===a.status)try{o._data=JSON.parse(a.responseText),o._error=!1}catch(e){}o.done()}},n&&(n=n(a)),a.send(n)):(o._done=o._error=!0,o.done())}function j(t,n,r,a){return n=n||r||T,n&&!s(n)&&(n=f(n)?n.call(t):e.querySelector(n)),(n=s(n)?n:ot)&&((a=n._$Cid)||(n._$Cid=a=++P),t._n[a]||(t._n[a]=[r=e.createComment("")],n.appendChild(r))),n}function x(e,t,n,a,o,i,l,p){var h,d,_,g,m,v,b,y;if(p===r&&(p=t[e]||R[e]),c(p))try{for(h=0;h<p.length&&x(e,t,n,a,o,i,0!==h,p[h])!==!1;h++);}catch(k){x(rt,t,[k,e,h,p[h]],a,o,i)}else if((p||p===ot)&&(v=j(o,p&&p.parent,a))){if(d=o._n[v._$Cid],b=d[0],_=o._p,p){if(y=[].concat(n,_,o),i&&y.push(i),f(p)){if(g=p.apply(o,y),g===!1)return g;g===ot&&(p=ot),u(g)&&(h=g)}else h=u(p)?p:p.template;u(h)&&(g=$C.tpl[h].apply(ot,y))}if((!p||s(g))&&(A(J,0),l||(l=p&&p.replace===!1),l||A(d,1),p))if(11===g.nodeType)for(h=g.firstChild;h;)d.push(h),h[K]=o,h=h.nextSibling;else(m=g.parentNode)&&m.removeChild(g),d.push(g),g[K]=o;s(g)&&(m=b.parentNode)&&m.insertBefore(g,b)}}function $(t,n,a){if(!(t._data instanceof $)){var i,s,l,p,d=t._data!==r&&!t._dataError,_=this,g=_.datas=[],m=t[Q],v=0,b=t.render,y=function(e,a,i,f,c,u){if(e!==r&&(g[e]=a,v--),!v&&!_.rejected&&(u=t._dataError,f=t.children,d||(t._data=g,t.isForm&&o(t.parent,t,V),u?(x(tt,b,[],l,t,n),h(tt,t)):(x(et,b,g,l,t,n),h(et,t)),x(nt,b,u?[!0]:[],l,t,n),h(nt,t)),!u))for(i=0;i<f.length;i++)c=f[i],c._id in I&&new $(c)};if(!d&&(t._data=_,l=j(t,t.renderParent),e.title=(i=f(i=t.title)?i():i)===r?N:i,x(Z,b,[],l,t,n),h(Z,t),m!==r))for(c(m)||(m=[m]),p=function(e){v++,s.then(function(t){y(e,t)},function(){t._dataError=!0,y(e)})},i=0;i<m.length;i++)s=m[i],u(s)&&(s=new w(s,t,a)),f(s)&&(s=s.call(t)),g.push(s),s&&f(s.then)&&p(i);y()}}function C(e,t){var n,a;for(n=e.children,a=n.length;a--;)C(n[a]);e._data&&f(e._data.reject)&&(e._data.reject(),h("stop",e)),e._data!==r&&(e._data=e._dataError=r,h("leave",e),E(e,t))}function E(e,t){var n,r,a;n=e._n,t=t?1:0;for(r in n)for(a=n[r];a.length>t;)J.push(a.pop());t||(e._n={})}function A(e,t,n,r){for(;e.length>t;)r=e.pop(),(n=r.parentNode)&&n.removeChild(r)}function H(e){var t,n,a,o,i,f,u,s=[],l=[];if(e instanceof HTMLFormElement)for(a=e.elements,t=0;t<a.length;t++){if(o=a[t],u=r,i=o.name)switch(o.type){case it:case"reset":case"button":case"file":break;case"checkbox":case"radio":o.checked&&(u=o.value||"");break;case"select-multiple":for(f=o.options,u=[],n=0;n<f.length;n++)f[n].selected&&u.push(f[n].value);break;default:u=o.value||""}if(l.push([o,u]),!o.disabled&&u!==r)for(c(u)||(u=[u]),n=0;n<u.length;n++)s.push({name:i,value:u[n]})}return[s,l]}var N,R,T,S,q,D,F,L,O,I={},M=[],P=0,U={},J=[],B={before:{},success:{},error:{},after:{},stop:{},except:{},leave:{},busy:{},idle:{}},G=!1,X=0,z=/[\x20\t\r\n\f]+/,K="_$Croute",Q="dataSource",V="valid",W="invalid",Y="sending",Z="before",et="success",tt="error",nt="after",rt="except",at=[Z,et,tt,nt,rt],ot=null,it="submit",ft=v.prototype,ct=function(e,t){return l(),u(e)&&u(t)?$H.on(e,t):e?i(e,t):L||(L=t),ct};return ct.add=ct,ct.set=function(e,t){return l(!0),D=t,$H.go(e)},ct.run=function(t){l(),t=t||{},N=t.title||"",R=b(t.render),T=t.parent||e.body,L&&i(r,L),$H.on(r,function(){var e,t,n,a,o,i,f={};for(t=0;t<M.length;t++)if(a=M[t],a._a){for(e=a,i=a._flat,n=0;n<i.length;n++)o=i[n],o._a&&(f[o._id]=o);break}for(t in I)a=I[t],t in f&&!D&&a._s&&a.keep!==!1&&!a._dataError||C(a);I=f,D=r,e&&new $(e)}),ct.on("before after stop",function(e){X+=e===Z?1:-1,O&&clearTimeout(O),O=setTimeout(function(){e=G,G=!!X,O=r,e!==G&&h(X?"busy":"idle",ct)},0)}),e.body.addEventListener("click",function(e){for(var t=e.target;t&&!(t instanceof HTMLAnchorElement);)t=t.parentNode;t&&t.host===location.host&&(e.preventDefault(),ct.set(t.href))},!1),e.body.addEventListener(it,function(e){for(var t,r,a,i,c=e.target,u=c;c;){if((t=c[K])&&(r=t.form)){e.preventDefault(),a=H(u),I[r._id]=r,r._n=t._n,r._f=a[1],r.checkForm(a=a[0])&&(C(r,!0),r[Q]=f(i=u.getAttribute("action")||r.action)?i.call(u,a,t):i,r.method=u.getAttribute("method")||r._method,o(t,r,Y),new $(r,u,function(e,o,i,f,c,s){if(o=r.type,e.setRequestHeader("Content-Type","text"===o?"text/plain":"json"===o?"application/json":"application/x-www-form-urlencoded"),a=(i=r[it])?i.call(u,a,e,t):a,"json"===o)return JSON.stringify(a);if(a){if("text"===o)return a+"";for(f=[],c=0;c<a.length;c++)s=a[c],f.push(n(s.name)+"="+n(s.value));return f.join("&")}}));break}c=c.parentNode}}),S=!0,$H.run()},ct.on=function(e,t,n){var r,a,o="";if(u(e)&&f(t))if(e=e.split(z),1===e.length)(r=B[e])&&(n&&((o=U[n])&&(n=o),o=n._id),(a=r[o])||(a=r[o]=[]),a.push(t));else for(o=e.length;o--;)ct.on(e[o],t,n);return ct},ct.off=function(e,t,n){var r,a="";if(u(e)&&f(t))if(e=e.split(z),1===e.length){if(n&&((a=U[n])&&(n=a),a=n._id),(r=B[e])&&(r=r[a]))for(a=r.length;a--;)r[a]===t&&r.splice(a,1)}else for(a=e.length;a--;)ct.on(e[a],t,n);return ct},ct.get=function(e){return U[e]},ft.reload=function(){var e,t=this;if(t._id in I){for(e=t.parent;e&&!(e._data instanceof $);)e=e.parent;e||(C(t,!0),new $(t))}},ft.params=function(e){var t=this;for(e=e||0;t&&e>0;)t=t.parent,e--;return t&&t._p||r},ft.data=function(e){var t,n=this;for(e=e||0;n&&e>0;)n=n.parent,e--;return t=n&&n._data,c(t)?c(this[Q])?t:t[0]:r},ft.makeURI=function(e){return k(this,this.uri,e||{})},ft.active=function(){return this._id in I},ft.checkForm=function(e){var t,n,o,i,f=this,c=f._f||[],u=f.parent,s=f.check;for(t=0;t<c.length;t++)n=c[t],o=s?s.call(u,n[0],n[1],e):r,a(u,f,n,o?(i=!0,W):V,o);return!i},$H.on({search:function(e,n,r,a,o,i,f){for(n=M.length;n--;)for(i=M[n],f=i._flat,r=f.length;r--;)f[r]._a=0;for(q={},e=e.split("&"),n=0;n<e.length;n++)(a=e[n])&&(~(o=a.indexOf("="))?(o=a.substring(o+1),a=t(a.substring(0,a.length-o.length-1)),o=t(o)):o=ot,(i=q[a])?(c(i)||(i=[i]),i.push(o)):i=o,q[a]=i)}},{}),ft=w.prototype,ft.then=function(e,t){var n=this;e&&n.ok.push(e),t&&n.error.push(t),n.done()},ft.reject=function(){var e=this;e._done||(e._r&&(e._r.abort(),e._r=r),e._done=e._error=!0,e.done())},ft.done=function(){var e,t,n=this;if(n._done)for(n._error?e=n.error:(e=n.ok,t=n._data);e.length;)e.shift()(t)},$.prototype.reject=function(){var e,t,n=this.datas;for(this.rejected=!0,e=n.length;e--;)t=n[e],f(t.abort)&&t.abort(),f(t.reject)&&t.reject()},ct}(document,decodeURIComponent,encodeURIComponent);